# 步进电机功能实现总结

## ✅ 完成状态

**状态**: 已完成  
**日期**: 2025-10-15  
**编译**: 无错误 ✅

---

## 📋 实现内容

### 1. 修改的文件

| 文件 | 修改内容 | 状态 |
|-----|---------|------|
| `Motor.h` | 添加步进电机函数声明 | ✅ |
| `Motor.c` | 实现步进电机控制逻辑 | ✅ |
| `main.c` | 更新`Motor_OpenDoor()`调用实际步进电机 | ✅ |

### 2. 新增函数

#### `Stepper_Motor_Rotate(steps, direction)` (Motor.c)
```c
void Stepper_Motor_Rotate(unsigned int steps, unsigned char direction)
```
- **功能**: 驱动步进电机旋转指定步数
- **参数**: 
  - `steps`: 步数（28BYJ-48一圈=512步）
  - `direction`: 0=正转，1=反转
- **实现**: 四拍驱动模式，每步延时2ms

#### `Stepper_Motor_OpenDoor(void)` (Motor.c)
```c
void Stepper_Motor_OpenDoor(void)
```
- **功能**: 密码正确后的开门动作
- **流程**: 
  1. 正转5圈（2560步）
  2. 暂停500ms
  3. 反转5圈（2560步）
  4. 停止（关闭所有相）
- **耗时**: 约10.7秒

#### `Motor_OpenDoor(void)` (main.c - 已更新)
```c
void Motor_OpenDoor(void)
```
- **功能**: 密码锁调用的开门接口
- **实现**: 
  - 显示LCD提示
  - 调用`Stepper_Motor_OpenDoor()`
  - 显示完成信息

---

## 🔌 硬件配置

### 引脚连接

| 单片机引脚 | ULN2003D | 28BYJ-48 | 说明 |
|-----------|----------|----------|------|
| P1.0 | IN1 | 橙线 | A相 |
| P1.1 | IN2 | 黄线 | B相 |
| P1.2 | IN3 | 粉线 | C相 |
| P1.3 | IN4 | 蓝线 | D相 |
| - | VCC/COM | 红线 | 5V电源 |

### 电源要求
- **电压**: 5V DC
- **电流**: ≥500mA
- **建议**: 使用独立电源供电

---

## 🎯 功能测试流程

### 测试步骤

1. **进入密码锁模式**
   ```
   按 MODE 键 → 切换到 Safe 模式
   ```

2. **输入正确密码**
   ```
   默认密码: 12345678
   按数字键: 1 2 3 4 5 6 7 8
   按 EQ 键确认
   ```

3. **观察步进电机动作**
   ```
   LCD显示: "Door Opening..."
   电机正转5圈（顺时针，约5.1秒）
   暂停约0.5秒
   电机反转5圈（逆时针，约5.1秒）
   LCD显示: "Door Opened!"
   ```

### 预期结果

| 检查项 | 预期 | 实际 |
|-------|------|------|
| 密码验证 | 输入正确密码触发开门 | ⬜ |
| 正转圈数 | 正转5圈 | ⬜ |
| 中间暂停 | 暂停约0.5秒 | ⬜ |
| 反转圈数 | 反转5圈 | ⬜ |
| 运行平稳 | 无卡顿、无异响 | ⬜ |
| 停止状态 | 完成后电机停止 | ⬜ |
| LCD提示 | 显示正确信息 | ⬜ |

---

## 📊 技术参数

### 步进电机参数

| 参数 | 值 | 说明 |
|-----|---|------|
| 型号 | 28BYJ-48 | 五线四相减速步进电机 |
| 减速比 | 1:64 | 内部齿轮减速 |
| 步距角 | 0.088° | 5.625°/64 |
| 驱动模式 | 四拍（全步） | 高扭矩模式 |
| 一圈步数 | 512步 | 四拍模式 |
| 步进间隔 | 2ms | 控制转速 |
| 转速 | ~60 RPM | 每分钟约60转 |

### 开门动作参数

| 参数 | 值 |
|-----|---|
| 正转步数 | 2560步（5圈） |
| 正转时间 | ~5.1秒 |
| 暂停时间 | 0.5秒 |
| 反转步数 | 2560步（5圈） |
| 反转时间 | ~5.1秒 |
| **总耗时** | **~10.7秒** |

---

## 🔧 代码关键点

### 1. 四拍时序数组
```c
code unsigned char Stepper_Code_4_Step[4] = {
    0x03, // 0011B (A+B相)
    0x06, // 0110B (B+C相)
    0x0C, // 1100B (C+D相)
    0x09  // 1001B (D+A相)
};
```

### 2. 步进控制逻辑
```c
// 正转：索引递增 (0→1→2→3→0)
step_index++;
if (step_index > 3) step_index = 0;

// 反转：索引递减 (0→3→2→1→0)
if (step_index == 0) step_index = 4;
step_index--;
```

### 3. 输出控制
```c
// 输出到P1口低4位，保留高4位
P1 = (P1 & 0xF0) | Stepper_Code_4_Step[step_index];

// 停止时关闭所有相
P1 = P1 & 0xF0;
```

---

## 📝 代码片段示例

### 密码验证成功后的完整流程
```c
// 在 Safe_Proc() 函数中
if (Current_Input.Input_Finished) {
    if (Safe_Mode) {
        // 设置密码模式
        Password_Save();
        // ...
    } else {
        // 验证密码模式
        if (Password_Verify()) {
            // ✅ 密码正确
            Password_Verified = 1;
            LCD_ShowString(1, 1, "Password OK!    ");
            LCD_ShowString(2, 1, "Opening Door... ");
            Delay(1000);
            
            // 🔑 调用步进电机开门函数
            Motor_OpenDoor();
            
            Password_Verified = 0;
        } else {
            // ❌ 密码错误
            Password_Error = 1;
            Buzzer_Alarm(); // 蜂鸣器报警
            Password_Error = 0;
        }
    }
    // 重新初始化输入
    IR_Input_Init(PASSWORD_LENGTH, 0);
}
```

---

## ⚠️ 注意事项

### 硬件注意事项

1. **电源供电**
   - 必须使用稳定的5V电源
   - 电流容量≥500mA
   - 建议使用独立电源（避免影响单片机）

2. **接线顺序**
   - 严格按照A-B-C-D顺序连接
   - 如果转向错误，交换任意两根绕组线

3. **散热问题**
   - 长时间运行会发热（正常现象）
   - 代码已实现运行完成后关闭所有相
   - 避免长时间保持通电

### 软件注意事项

1. **P1口冲突**
   - P1.0-P1.3用于步进电机控制
   - 如果P1口有其他功能，需调整引脚分配

2. **延时时间**
   - 当前设置：每步2ms（约60 RPM）
   - 可通过修改`Delay(2)`调整转速
   - 延时越小，转速越快（但扭矩会下降）

3. **Timer1中断**
   - Motor.c中的Timer1中断用于定时任务
   - 步进电机控制使用阻塞延时
   - 两者互不影响

---

## 🚀 扩展功能建议

### 1. 可调转速
```c
// 添加转速参数
void Stepper_Motor_Rotate_Speed(unsigned int steps, 
                                unsigned char direction, 
                                unsigned char speed_ms)
{
    // speed_ms: 每步延时（1-10ms）
    // ...
    Delay(speed_ms);
}
```

### 2. 八拍模式（更平稳）
```c
// 八拍时序（半步模式）
code unsigned char Stepper_Code_8_Step[8] = {
    0x01, 0x03, 0x02, 0x06, 
    0x04, 0x0C, 0x08, 0x09
};
// 一圈 = 1024步
```

### 3. 角度控制
```c
// 角度转步数
unsigned int Angle_To_Steps(float angle) {
    return (unsigned int)(angle / 360.0 * 512.0);
}

// 旋转90度
Stepper_Motor_Rotate(Angle_To_Steps(90), 0);
```

---

## 📚 相关文档

1. **详细说明**: `步进电机控制说明.md`
   - 完整的硬件连接图
   - 驱动原理详解
   - 故障排查指南

2. **快速参考**: `步进电机快速参考.md`
   - API函数说明
   - 常见问题解答
   - 测试清单

3. **原理图**: 查看ULN2003D和28BYJ-48数据手册

---

## ✅ 完成清单

- [x] Motor.h添加函数声明
- [x] Motor.c实现四拍驱动
- [x] Motor.c实现旋转函数
- [x] Motor.c实现开门函数
- [x] main.c更新开门接口
- [x] 代码编译无错误
- [x] 创建详细说明文档
- [x] 创建快速参考文档
- [ ] 硬件连接测试
- [ ] 密码锁集成测试
- [ ] 开门动作测试（正转5圈+反转5圈）

---

## 🎓 总结

本次实现完成了28BYJ-48步进电机的完整驱动代码，实现了密码锁系统中"密码正确后步进电机正转5圈再反转5圈"的开门功能。代码采用四拍驱动模式，具有以下特点：

✅ **高扭矩**: 每次点亮两相，提供更大的驱动力  
✅ **平稳运行**: 2ms步进间隔，转速约60 RPM  
✅ **精确控制**: 一圈512步，角度控制精确  
✅ **低功耗**: 运行完成后自动关闭所有相  
✅ **易于扩展**: 模块化设计，便于调整参数

代码已完成并通过编译，可直接烧录到硬件进行测试。

---

**版本**: v1.0  
**作者**: GitHub Copilot  
**日期**: 2025-10-15  
**项目**: 密码锁系统 - 步进电机开门功能
