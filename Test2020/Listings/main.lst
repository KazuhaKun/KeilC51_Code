C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          // --- START OF FILE main.c ---
   2          
   3          #include <REGX52.H>
   4          #include "Delay.h"
   5          #include "Key.h"
   6          #include "Nixie.h"
   7          #include "Motor.h"
   8          #include "IR.h"
   9          #include "LCD1602.h"
  10          #include "Buzzer.h"
  11          #include <STDIO.H> // **ç§»é™¤æˆ–æ³¨é‡Šæ‰æ­¤è¡Œä»¥èŠ‚çœå†…å­˜ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†ä½¿ç”¨ sprintf**
  12          #include "DS1302.h"
  13          // #include "string.h" // **ç§»é™¤æˆ–æ³¨é‡Šæ‰æ­¤è¡Œä»¥èŠ‚çœå†…å­˜ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†ä½¿ç”¨ string.h å‡
             -½æ•°**
  14          #include "DS18B20.h"
  15          #include "AT24C02.h"
  16          #include "Timer0.h"
  17          #include "Timer1.h"
  18          
  19          /*PD*/
  20          #define LINE_MAX_LENGTH 16
  21          // ç›®æ ‡è¾“å…¥é•¿åº¦ï¼šå¹´(2)æœˆ(2)æ—¥(2)æ—¶(2)åˆ†(2)ç§’(2) = 12ä½æ•°å­—
  22          #define CALENDAR_INPUT_LEN 12 
  23          
  24          /*PD End*/
  25          /*PV*/
  26          // ... (ä¿æŒåŸæ ·)
  27          unsigned char Time_5s_Count = 0;    // ç”¨äº5ç§’æ¸©åº¦ä»»åŠ¡
  28          
  29          bit Flag_100ms_Task = 0;  // 100æ¯«ç§’ä»»åŠ¡ï¼ˆDS1302è¯»å–ã€LCDåˆ·æ–°ï¼ˆæ–°ï¼‰ï¼‰
  30          bit Flag_500ms_Task = 0;  // 500æ¯«ç§’ä»»åŠ¡ï¼ˆè®¾ç½®é—ªçƒï¼‰
  31          bit Flag_1s_Task = 0;       // 1ç§’ä»»åŠ¡ï¼ˆDS1302è¯»å–ã€LCDåˆ·æ–°ï¼‰
  32          bit Flag_5s_Task = 0;       // 5ç§’ä»»åŠ¡ï¼ˆDS18B20å¼€å§‹è½¬æ¢ï¼‰
  33          bit Flag_750ms_Ready = 0;   // DS18B20 750ms è½¬æ¢å®Œæˆæ ‡å¿—
  34          
  35          // DS18B20 çŠ¶æ€æœº
  36          char Temp_State = 0; // 0: Idle, 1: Convert Started, 2: Read Value
  37          
  38          typedef enum {
  39            Calendar,
  40            Safe,
  41            Calculator
  42          } Mode;
  43          Mode mode=Calendar;
  44          
  45          
  46          
  47          unsigned char IR_Cmd=0;
  48          
  49          xdata char Init_Time[]={19,12,31,23,59,0,2};  //åˆå§‹æ—¶é—´
  50          xdata char Set_Time[7];
  51          xdata char Plause_Time[7];
  52          xdata char L1_String[LINE_MAX_LENGTH]="";
  53          xdata char L2_String[LINE_MAX_LENGTH]="";
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 2   

  54          
  55          xdata int Temperature = 20; // ç”¨äºå­˜å‚¨è¯»å–çš„æ¸©åº¦å€¼
  56          xdata int Temperature_Point = 0; // ç”¨äºå­˜å‚¨æ¸©åº¦çš„å°æ•°éƒ¨åˆ†
  57          
  58          #define MAX_INPUT_DIGITS 16 // æœ€å¤§æ”¯æŒ16ä½æ•°å­—è¾“å…¥
  59          
  60          // è¾“å…¥ç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨è¾“å…¥çŠ¶æ€
  61          typedef struct {
  62              unsigned char Digit_Buffer[MAX_INPUT_DIGITS]; // å­˜å‚¨è¾“å…¥çš„æ•°å­—ï¼ˆ0-9çš„æ•°å€¼ï¼‰
  63              unsigned char Target_Length;                  // ç›®æ ‡è¾“å…¥é•¿åº¦
  64              unsigned char Current_Cursor;                 // å½“å‰å…‰æ ‡ä½ç½® (0 åˆ° Target_Length - 1)
  65              unsigned char Input_Finished;                  // è¾“å…¥å®Œæˆæ ‡å¿— (é€šå¸¸ç”±ç¡®è®¤é”®è®¾ç½®)
  66              unsigned char Blinking_State;                  // ç”¨äºé—ªçƒæ˜¾ç¤ºçš„æ ‡å¿—
  67          } IR_Input_State;
  68          
  69          // å…¨å±€å˜é‡ï¼Œç”¨äºä¿å­˜å½“å‰è¾“å…¥çŠ¶æ€
  70          xdata IR_Input_State Current_Input;
  71          
  72          /*PV End*/
  73          
  74          /*Module Code*/
  75          // ... (AT24C02_clearTime, LCD1602_Test, IR_Data_Proc, Mode_Change, IR_Cmd_To_Digit ä¿æŒåŸæ ·)
  76          
  77          void AT24C02_clearTime(void){
  78   1        unsigned char i;
  79   1        for(i=0; i<7; i++){
  80   2          AT24C02_WriteByte(0x00 + i, 0x00);  
  81   2          Delay(5);
  82   2        }
  83   1      }
  84          void LCD1602_Test(void){
  85   1        LCD_ShowString(1,1,"Hello,World!    ");
  86   1        LCD_ShowString(2,1,"LCD1602 Test    ");
  87   1      }
  88          
  89          void IR_Data_Proc(void)
  90          {
  91   1        if (IR_GetDataFlag()){IR_Cmd=IR_GetCommand();}
  92   1      }
  93          void Mode_Change(void){
  94   1        if (IR_Cmd == IR_MODE){
  95   2          mode = (Mode)((mode + 1) % 3);
  96   2          IR_Cmd = 0;
  97   2        }else if (IR_Cmd == IR_POWER){
  98   2          mode = Calendar;  //é‡ç½®
  99   2          IR_Cmd = 0;
 100   2        }
 101   1      }
 102          
 103          // å°†çº¢å¤–å‘½ä»¤è½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­— (0-9)ï¼Œå¦‚æœä¸æ˜¯æ•°å­—åˆ™è¿”å› 0xFF
 104          unsigned char IR_Cmd_To_Digit(unsigned char cmd) {
 105   1          switch (cmd) {
 106   2              case IR_0: return 0;
 107   2              case IR_1: return 1;
 108   2              case IR_2: return 2;
 109   2              case IR_3: return 3;
 110   2              case IR_4: return 4;
 111   2              case IR_5: return 5;
 112   2              case IR_6: return 6;
 113   2              case IR_7: return 7;
 114   2              case IR_8: return 8;
 115   2              case IR_9: return 9;
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 3   

 116   2              default: return 0xFF; // è¿”å›æ— æ•ˆå€¼
 117   2          }
 118   1      }
 119          
 120          void Calendar_Init(void){
 121   1          unsigned char i;
 122   1        DS1302_Init();
 123   1        // EEPROM è¯»æ—¶é—´
 124   1          for(i=0; i<7; i++){
 125   2              DS1302_Time[i] = AT24C02_ReadByte(0x00 + i);
 126   2          }
 127   1          
 128   1          // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
 129   1          if (DS1302_Time[0] == 0x00) { 
 130   2              const char code Init_Time[] = {19,12,31,23,59,0,2}; 
 131   2              for(i=0; i<sizeof(Init_Time); i++){
 132   3                  DS1302_Time[i] = Init_Time[i];
 133   3              }
 134   2          }
 135   1          // è®¾ç½®æ—¶é—´åˆ° DS1302
 136   1        DS1302_SetTime();
 137   1          
 138   1        // å¤‡ä»½æ—¶é—´åˆ° EEPROM
 139   1          for(i=0; i<7; i++){
 140   2              AT24C02_WriteByte(0x00 + i, DS1302_Time[i]); 
 141   2              Delay(5);
 142   2          }
 143   1      }
 144          
 145          // **ä¿®æ”¹ï¼šä½¿ç”¨æ‰‹åŠ¨ASCIIè½¬æ¢ï¼Œç§»é™¤ sprintf**
 146          void Calendar_Disp(void){
 147   1          unsigned char i, j;
 148   1        DS1302_ReadTime(); // ä»DS1302è¯»å–æ—¶é—´
 149   1          
 150   1          // ====== L1: 20YY-MM-DD (16 chars) ======
 151   1          L1_String[0] = '2'; L1_String[1] = '0';
 152   1          L1_String[4] = '-'; L1_String[7] = '-';
 153   1          
 154   1          // YY (i=0, L1_String index 2,3)
 155   1          L1_String[2] = DS1302_Time[0]/10 + '0';
 156   1          L1_String[3] = DS1302_Time[0]%10 + '0';
 157   1          
 158   1          // MM (i=1, L1_String index 5,6)
 159   1          L1_String[5] = DS1302_Time[1]/10 + '0';
 160   1          L1_String[6] = DS1302_Time[1]%10 + '0';
 161   1          
 162   1          // DD (i=2, L1_String index 8,9)
 163   1          L1_String[8] = DS1302_Time[2]/10 + '0';
 164   1          L1_String[9] = DS1302_Time[2]%10 + '0';
 165   1          
 166   1          // å¡«å……å‰©ä½™ç©ºæ ¼
 167   1          for (i = 10; i < LINE_MAX_LENGTH; i++) { L1_String[i] = ' '; }
 168   1          L1_String[LINE_MAX_LENGTH-1] = '\0';
 169   1          
 170   1        LCD_ShowString(1,1,L1_String);
 171   1      
 172   1          // ====== L2: HH:mm:ss  Temp.Temp_Point C (16 chars) ======
 173   1          L2_String[2] = ':'; L2_String[5] = ':';
 174   1          
 175   1          // HH (i=3, L2_String index 0,1)
 176   1          L2_String[0] = DS1302_Time[3]/10 + '0';
 177   1          L2_String[1] = DS1302_Time[3]%10 + '0';
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 4   

 178   1          
 179   1          // mm (i=4, L2_String index 3,4)
 180   1          L2_String[3] = DS1302_Time[4]/10 + '0';
 181   1          L2_String[4] = DS1302_Time[4]%10 + '0';
 182   1          
 183   1          // ss (i=5, L2_String index 6,7)
 184   1          L2_String[6] = DS1302_Time[5]/10 + '0';
 185   1          L2_String[7] = DS1302_Time[5]%10 + '0';
 186   1      
 187   1          L2_String[8] = ' ';
 188   1          L2_String[9] = ' ';
 189   1          
 190   1          // Temp (L2_String index 10,11)
 191   1          // å‡è®¾ Temperature <= 99
 192   1          L2_String[10] = Temperature/10 + '0';
 193   1          L2_String[11] = Temperature%10 + '0';
 194   1          
 195   1          L2_String[12] = '.';
 196   1          
 197   1          // Temp_Point (L2_String index 13,14)
 198   1          L2_String[13] = Temperature_Point/10 + '0';
 199   1          L2_String[14] = Temperature_Point%10 + '0';
 200   1          
 201   1          L2_String[15] = 'C';
 202   1          L2_String[LINE_MAX_LENGTH] = '\0'; // ç¡®ä¿å­—ç¬¦ä¸²æ­£ç¡®ç»ˆæ­¢
 203   1          
 204   1        LCD_ShowString(2,1,L2_String);
 205   1      }
*** WARNING C280 IN LINE 147 OF main.c: 'j': unreferenced local variable
 206          
 207          void Time_Backup(void){
 208   1      // ... (ä¿æŒåŸæ ·)
 209   1        //æ¯ç§’å¤‡ä»½ç§’
 210   1        AT24C02_WriteByte(0x05, DS1302_Time[5]);
 211   1        // Delay(5);
 212   1        //æ¯åˆ†é’Ÿå¤‡ä»½åˆ†
 213   1        if (DS1302_Time[5] == 0) {
 214   2          AT24C02_WriteByte(0x04, DS1302_Time[4]);
 215   2          // Delay(5);
 216   2        }
 217   1        //æ¯å°æ—¶å¤‡ä»½æ—¶
 218   1        if (DS1302_Time[4] == 0 && DS1302_Time[5] == 0) {
 219   2          AT24C02_WriteByte(0x03, DS1302_Time[3]);
 220   2          // Delay(5);
 221   2        }
 222   1      }
 223          
 224          /**
 225           * @brief åˆå§‹åŒ–çº¢å¤–è¾“å…¥æ¨¡å— åˆå§‹åŒ–é•¿åº¦ã€åˆå§‹å€¼ã€å…‰æ ‡ä½ç½®ã€è¾“å…¥çŠ¶æ€ç­‰
 226           * @param Target_Length ç›®æ ‡è¾“å…¥çš„æ•°å­—ä½æ•° (ä¾‹å¦‚ï¼šæ—¥å†æ—¶é—´è®¾ç½®æ€»å…±14ä½)
 227           * @param Initial_Values å¯é€‰çš„åˆå§‹å€¼æ•°ç»„ (å¦‚æœéœ€è¦é¢„å¡«å……)ï¼Œå¯ä¼ å…¥ NULL
 228           */
 229          void IR_Input_Init(unsigned char Target_Length, unsigned char *Initial_Values)
 230          {
 231   1          unsigned char i;
 232   1          
 233   1          // é™åˆ¶æœ€å¤§é•¿åº¦
 234   1          if (Target_Length > MAX_INPUT_DIGITS) {
 235   2              Target_Length = MAX_INPUT_DIGITS;
 236   2          }
 237   1      
 238   1          Current_Input.Target_Length = Target_Length; // ç›®æ ‡é•¿åº¦ï¼š12
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 5   

 239   1          Current_Input.Current_Cursor = 0; // å…‰æ ‡ä»ç¬¬ä¸€ä½å¼€å§‹
 240   1          Current_Input.Input_Finished = 0; // è¾“å…¥æœªå®Œæˆ
 241   1      
 242   1          // å¾ªç¯6æ¬¡ï¼Œå¯¹åº”6ä¸ªæ—¶é—´åˆ†é‡ (å¹´,æœˆ,æ—¥,æ—¶,åˆ†,ç§’)
 243   1          for (i = 0; i < 6; i++) 
 244   1          {
 245   2              // Target_Length æ˜¯ 12ã€‚æˆ‘ä»¬æ£€æŸ¥ i*2 æ˜¯å¦åœ¨èŒƒå›´å†…
 246   2              if (i*2 < Target_Length && Initial_Values != NULL) {
 247   3                  // å°†ä¸¤ä½æ•°ï¼ˆä¾‹å¦‚ 19ï¼‰æ‹†åˆ†æˆä¸¤ä¸ªæ•°å­—ï¼ˆ1 å’Œ 9ï¼‰
 248   3                  Current_Input.Digit_Buffer[i*2] = Initial_Values[i]/10;
 249   3            Current_Input.Digit_Buffer[i*2+1] = Initial_Values[i]%10;
 250   3              } else {
 251   3                  // å¦åˆ™åˆå§‹åŒ–ä¸º 0
 252   3                  Current_Input.Digit_Buffer[i*2] = 0; 
 253   3            Current_Input.Digit_Buffer[i*2+1] = 0;
 254   3              }
 255   2          }
 256   1      }
 257          
 258          void IR_Input_Proc(unsigned char ir_digit){
 259   1        if(Current_Input.Target_Length == 0 || Current_Input.Input_Finished){
 260   2          return; // å¦‚æœæ²¡æœ‰è®¾ç½®ç›®æ ‡é•¿åº¦æˆ–è¾“å…¥å·²å®Œæˆï¼Œç›´æ¥è¿”å›
 261   2        }
 262   1        
 263   1          // 1. å­˜å‚¨æ–°çš„æ•°å­—
 264   1        Current_Input.Digit_Buffer[Current_Input.Current_Cursor] = ir_digit;
 265   1      
 266   1          // 2. ç§»åŠ¨å…‰æ ‡
 267   1        Current_Input.Current_Cursor++;
 268   1      
 269   1          // 3. æ£€æŸ¥æ˜¯å¦å®Œæˆè¾“å…¥
 270   1          if (Current_Input.Current_Cursor >= Current_Input.Target_Length) {
 271   2              Current_Input.Input_Finished = 1; // 12ä½è¾“å…¥å®Œæˆ
 272   2              Current_Input.Current_Cursor = 0; // å…‰æ ‡å½’é›¶
 273   2          }
 274   1      }
 275          
 276          // **æ–°å¢/ä¿®æ”¹ï¼šä½¿ç”¨æ‰‹åŠ¨ç´¢å¼•å’Œèµ‹å€¼ï¼Œç§»é™¤ strlen**
 277          void Calendar_Build_String_Set(bit Blink_State)
 278          {
 279   1          unsigned char i;
 280   1          unsigned char digit;
 281   1          unsigned char L1_Cursor = 0;
 282   1          unsigned char L2_Cursor = 0;
 283   1          
 284   1          // ====== L1: 20YY-MM-DD (16 chars) ======
 285   1          // 20
 286   1          L1_String[L1_Cursor++] = '2'; 
 287   1          L1_String[L1_Cursor++] = '0';
 288   1          
 289   1          for (i = 0; i < 6; i++) // Digits 0 to 5 (YY MM DD)
 290   1          {
 291   2              digit = Current_Input.Digit_Buffer[i];
 292   2              
 293   2              // é—ªçƒé€»è¾‘: å¦‚æœå½“å‰å…‰æ ‡ä½ç½® i ä¸” Blink_State ä¸ºçœŸï¼Œåˆ™æ˜¾ç¤ºç©ºæ ¼
 294   2              if (i == Current_Input.Current_Cursor && Blink_State) {
 295   3                  L1_String[L1_Cursor++] = ' ';
 296   3              } else {
 297   3                  L1_String[L1_Cursor++] = '0' + digit;
 298   3              }
 299   2              
 300   2              // æ·»åŠ åˆ†éš”ç¬¦ (åœ¨ YY2 (i=1) å’Œ MM2 (i=3) ä¹‹å)
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 6   

 301   2              if (i == 1 || i == 3) {
 302   3                  L1_String[L1_Cursor++] = '-';
 303   3              }
 304   2          }
 305   1          // å¡«å……L1é•¿åº¦
 306   1          while (L1_Cursor < LINE_MAX_LENGTH) { L1_String[L1_Cursor++] = ' '; }
 307   1          L1_String[LINE_MAX_LENGTH-1] = '\0'; // å­—ç¬¦ä¸²ç»“æŸç¬¦
 308   1      
 309   1          // ====== L2: HH:mm:ss (16 chars) ======
 310   1          for (i = 6; i < 12; i++) // Digits 6 to 11 (HH mm ss)
 311   1          {
 312   2              digit = Current_Input.Digit_Buffer[i];
 313   2      
 314   2              // é—ªçƒé€»è¾‘
 315   2              if (i == Current_Input.Current_Cursor && Blink_State) {
 316   3                  L2_String[L2_Cursor++] = ' ';
 317   3              } else {
 318   3                  L2_String[L2_Cursor++] = '0' + digit;
 319   3              }
 320   2      
 321   2              // æ·»åŠ åˆ†éš”ç¬¦ (åœ¨ HH2 (i=7) å’Œ mm2 (i=9) ä¹‹å)
 322   2              if (i == 7 || i == 9) {
 323   3                  L2_String[L2_Cursor++] = ':';
 324   3              }
 325   2          }
 326   1          // å¡«å……L2é•¿åº¦
 327   1          while (L2_Cursor < LINE_MAX_LENGTH) { L2_String[L2_Cursor++] = ' '; }
 328   1          L2_String[LINE_MAX_LENGTH-1] = '\0'; // å­—ç¬¦ä¸²ç»“æŸç¬¦
 329   1      }
 330          
 331          
 332          void Calendar_Set(void){
 333   1        static bit Cal_Set_Init_Flag = 0; // 0:æœªåˆå§‹åŒ–, 1:å·²åˆå§‹åŒ–
 334   1        unsigned char i;
 335   1        unsigned char ir_digit;
 336   1      
 337   1        
 338   1        if (!Cal_Set_Init_Flag) {
 339   2          DS1302_ReadTime(); // ä»DS1302è¯»å–æ—¶é—´
 340   2          for (i = 0; i < 7; i++){
 341   3            Plause_Time[i] = DS1302_Time[i];
 342   3          }
 343   2          IR_Input_Init(CALENDAR_INPUT_LEN, Plause_Time); // åˆå§‹åŒ–çº¢å¤–è¾“å…¥æ¨¡å—ï¼Œç›®æ ‡é•¿åº¦ä¸º12ï¼Œåˆ
             -å§‹å€¼ä¸ºå½“å‰æ—¶é—´
 344   2          Cal_Set_Init_Flag = 1;
 345   2              
 346   2              Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–°æ˜¾ç¤º
 347   2        }
 348   1          
 349   1          // 1. å¤„ç†çº¢å¤–è¾“å…¥
 350   1        ir_digit = IR_Cmd_To_Digit(IR_Cmd);
 351   1        if (ir_digit != 0xFF) { // ä»…å½“çº¢å¤–è¾“å…¥æ˜¯æœ‰æ•ˆæ•°å­—æ—¶æ‰å¤„ç†
 352   2          IR_Input_Proc(ir_digit); // å¤„ç†çº¢å¤–è¾“å…¥ï¼šå­˜å…¥Digit_Bufferï¼Œç§»åŠ¨å…‰æ ‡
 353   2          IR_Cmd = 0; // æ¸…é™¤å‘½ä»¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†
 354   2              Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–°æ˜¾ç¤º
 355   2        }
 356   1          // // å¤„ç†ç¡®è®¤é”® (ä¾‹å¦‚ IR_OK) - å¼ºåˆ¶å®Œæˆè¾“å…¥å¹¶ä¿å­˜
 357   1          // if (IR_Cmd == IR_EQ) {
 358   1          //     Current_Input.Input_Finished = 1;
 359   1          //     IR_Cmd = 0;
 360   1          // }
 361   1        
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 7   

 362   1          // 2. å‘¨æœŸæ€§åˆ·æ–°æ˜¾ç¤º (100ms ä»»åŠ¡)
 363   1          if (Flag_100ms_Task) {
 364   2              
 365   2              // 3. å¤„ç†æ˜¾ç¤ºï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶åœ¨å…‰æ ‡ä½ç½®åº”ç”¨é—ªçƒ
 366   2              Calendar_Build_String_Set(Flag_500ms_Task); // **ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„æ—  strlen å‡½æ•°**
 367   2      
 368   2              // æ˜¾ç¤ºå­—ç¬¦ä¸²
 369   2              LCD_ShowString(1,1,L1_String);
 370   2              LCD_ShowString(2,1,L2_String);
 371   2              
 372   2              Flag_100ms_Task = 0;
 373   2          }
 374   1      
 375   1      
 376   1        // 4. è¾“å…¥å®Œæˆåçš„æ•°æ®è½¬æ¢å’Œä¿å­˜
 377   1        if (Current_Input.Input_Finished)
 378   1        {
 379   2          // è¾“å…¥å®Œæˆï¼Œå°† 12 ä½æ•°å­—é‡æ–°ç»„åˆæˆ 6 ä¸ªæ—¶é—´åˆ†é‡
 380   2          for (i = 0; i < 6; i++)
 381   2          {
 382   3                  // Set_Time[0]=D[0]*10+D[1], Set_Time[1]=D[2]*10+D[3], ...
 383   3            Set_Time[i] = Current_Input.Digit_Buffer[i * 2] * 10 + Current_Input.Digit_Buffer[i * 2 + 1];
 384   3          }
 385   2              // æ˜ŸæœŸä¿æŒä¸å˜
 386   2              Set_Time[6] = Plause_Time[6]; 
 387   2      
 388   2          // æ›´æ–° DS1302 æ—¶é—´
 389   2          for(i=0; i<7; i++){
 390   3            DS1302_Time[i] = Set_Time[i];
 391   3          }
 392   2          DS1302_SetTime(); // è®¾ç½®æ—¶é—´
 393   2      
 394   2              // **æ–°å¢ï¼šå°†æ–°è®¾ç½®çš„æ—¶é—´åŒæ­¥ä¿å­˜åˆ° EEPROM**
 395   2              for(i=0; i<7; i++){
 396   3                  AT24C02_WriteByte(0x00 + i, Set_Time[i]); 
 397   3                  Delay(5);
 398   3              }
 399   2      
 400   2          Cal_Set_Init_Flag = 0; // é‡ç½®åˆå§‹åŒ–æ ‡å¿—ï¼Œä¸‹æ¬¡è¿›å…¥é‡æ–°åŠ è½½æ—¶é—´
 401   2              Current_Input.Input_Finished = 0; // é‡ç½®è¾“å…¥å®Œæˆæ ‡å¿—
 402   2        }
 403   1        
 404   1      }
 405          
 406          /*Module Code End*/
 407          
 408          /*Proc Code*/
 409          void Temp_Proc(void){
 410   1          if (mode != Calendar) return;
 411   1      
 412   1          if (Temp_State == 0) { // Idle çŠ¶æ€
 413   2              if (Flag_5s_Task) {
 414   3                  // å¼€å§‹æ¸©åº¦è½¬æ¢ï¼Œä¸é˜»å¡
 415   3            P3_5 = 1;
 416   3                  DS18B20_ConvertT(); // å‡è®¾è¿™ä¸ªå‡½æ•°åªæ˜¯å‘é€å¯åŠ¨å‘½ä»¤
 417   3                  Flag_5s_Task = 0;
 418   3                  Temp_State = 1; // è¿›å…¥è½¬æ¢ä¸­çŠ¶æ€
 419   3              }
 420   2          } else if (Temp_State == 1) { // è½¬æ¢ä¸­çŠ¶æ€
 421   2              if (Flag_750ms_Ready) {
 422   3            float temp;
 423   3                  // 750ms ç­‰å¾…å®Œæˆï¼Œè¯»å–æ¸©åº¦
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 8   

 424   3            P3_5 = 1;
 425   3            temp = DS18B20_ReadT();
 426   3            Temperature_Point = (int)(temp * 100) % 100;
 427   3            Temperature = (int)temp;
 428   3      
 429   3                  Flag_750ms_Ready = 0;
 430   3                  Temp_State = 0; // å›åˆ° Idle çŠ¶æ€
 431   3              }
 432   2          }
 433   1      }
 434          
 435          void Calendar_Proc(void){
 436   1        static bit Cal_Mode = 0; // 0:Display, 1:Set
 437   1        unsigned char ir_cmd_temp = 0; // ä¸´æ—¶å­˜å‚¨ IR_Cmd
 438   1      
 439   1        if (mode != Calendar) {return;}
 440   1          
 441   1          // 1. æš‚å­˜å‘½ä»¤å¹¶æ¸…é™¤ IR_Cmdï¼Œé˜²æ­¢åœ¨ Calendar_Set ä¸­è¢«æ•°å­—é”®è¯¯è§¦å‘
 442   1          ir_cmd_temp = IR_Cmd;
 443   1          IR_Cmd = 0;
 444   1          
 445   1        // 2. å‘¨æœŸæ€§ä»»åŠ¡å¤„ç†
 446   1          if (Cal_Mode) {
 447   2              // è®¾ç½®æ¨¡å¼
 448   2              
 449   2              // --- A. æŒ‰é”®å¤„ç† (åªå¤„ç†é€€å‡ºé”®) ---
 450   2              if (ir_cmd_temp == IR_EQ) {
 451   3                  // IR_EQï¼šä¿å­˜å¹¶é€€å‡ºã€‚é¦–å…ˆæ ‡è®°å®Œæˆï¼Œè®© Calendar_Set åœ¨æœ¬å‘¨æœŸæ‰§è¡Œä¿å­˜é€»
             -è¾‘ã€‚
 452   3                  Current_Input.Input_Finished = 1;
 453   3              } else if (ir_cmd_temp == IR_START_STOP) {
 454   3                  // IR_START_STOPï¼šä¸ä¿å­˜é€€å‡ºã€‚
 455   3                  Cal_Mode = 0; // ç«‹å³é€€å‡º
 456   3                  Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–°
 457   3              } else {
 458   3                  // å…¶ä»–é”®ï¼Œå¦‚æœæ˜¯æ•°å­—é”®ï¼Œäº¤ç»™ Calendar_Set å¤„ç†ï¼ˆIR_Cmd å·²ç»è¢«æ¸…ç©ºï¼Œè¿™é
             -‡Œéœ€è¦æ¢å¤ï¼‰
 459   3                  IR_Cmd = ir_cmd_temp; // æ¢å¤ IR_Cmd ç»™ Calendar_Set å¤„ç†æ•°å­—è¾“å…¥
 460   3              }
 461   2              
 462   2              // --- B. è®¾ç½®é€»è¾‘ (åŒ…æ‹¬è¾“å…¥å’Œä¿å­˜) ---
 463   2          Calendar_Set();
 464   2              
 465   2              // --- C. é€€å‡ºé€»è¾‘ (å¦‚æœ Calendar_Set åˆšåˆšå®Œæˆä¿å­˜) ---
 466   2              // Calendar_Set åœ¨ä¿å­˜å®Œæˆæ—¶ä¼šé‡ç½® Current_Input.Input_Finished ä¸º 0ã€‚
 467   2              // å¦‚æœæˆ‘ä»¬æ˜¯æŒ‰ IR_EQ è¿›æ¥çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¿å­˜å®Œæˆåé€€å‡ºã€‚
 468   2              if (ir_cmd_temp == IR_EQ && Cal_Mode == 1) { // æ£€æŸ¥æ˜¯å¦æŒ‰äº† IR_EQï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰é€€å‡º
 469   3                   // æ£€æŸ¥ä¿å­˜æ˜¯å¦æˆåŠŸå®Œæˆï¼ˆå¦‚æœ Calendar_Set é‡ç½®äº† Cal_Set_Init_Flagï¼Œåˆ™è®¤ä
             -¸ºå®Œæˆï¼‰
 470   3                   // æœ€ç®€å•çš„å°±æ˜¯æŒ‰ IR_EQ åå¼ºåˆ¶é€€å‡ºã€‚ç”±äº Calendar_Set å·²ç»åœ¨æœ¬å‘¨æœŸè¿è¡Œ
             -ï¼Œä¿å­˜å·²ç»å®Œæˆã€‚
 471   3                   Cal_Mode = 0;
 472   3                   Calendar_Disp(); // **ä¿®æ”¹ï¼šç«‹å³ä½¿ç”¨å·²æ›´æ–°çš„ DS1302_Time æ•°ç»„åˆ·æ–°æ˜¾ç¤º**
 473   3                   // Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–° (è¿™ä¸€è¡Œå¯ä»¥è¢«ä¸Šé¢çš„ç›´æ¥è°ƒç”¨æ›¿ä»£)
 474   3              }
 475   2              
 476   2              // 500ms ä»»åŠ¡ï¼šç”¨äºé—ªçƒåˆ‡æ¢
 477   2              if (Flag_500ms_Task) {
 478   3                  Flag_500ms_Task = 0;
 479   3              }
 480   2              
 481   2        } else {
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 9   

 482   2              // æ˜¾ç¤ºæ¨¡å¼
 483   2              
 484   2              // --- D. æŒ‰é”®å¤„ç† (åªå¤„ç†è¿›å…¥è®¾ç½®é”®) ---
 485   2              if (ir_cmd_temp == IR_START_STOP) {
 486   3                  // ä»æ˜¾ç¤ºæ¨¡å¼è¿›å…¥è®¾ç½®æ¨¡å¼
 487   3                  Cal_Mode = 1;
 488   3                  Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–°
 489   3              }
 490   2              
 491   2              // --- E. æ˜¾ç¤ºé€»è¾‘ ---
 492   2              if (Flag_100ms_Task) {
 493   3                  Calendar_Disp();
 494   3            Flag_100ms_Task = 0; 
 495   3              }
 496   2              // ... (Time_Backup å’Œ Temp_Proc ä¿æŒä¸å˜)
 497   2          if (Flag_1s_Task) {
 498   3            Time_Backup(); // æ¯ç§’å¤‡ä»½æ—¶é—´åˆ° EEPROM
 499   3            Flag_1s_Task = 0;
 500   3          }
 501   2              
 502   2              // 5ç§’ä»»åŠ¡ï¼šæ¸©åº¦è½¬æ¢å’Œè¯»å– (é€šè¿‡ Temp_Proc çŠ¶æ€æœºå¤„ç†)
 503   2              Temp_Proc();        
 504   2        }
 505   1      }
 506          // ... (Safe_Proc, Calculator_Proc, DS18B20_Test ä¿æŒåŸæ ·)
 507          void Safe_Proc(void){
 508   1        if (mode != Safe) {return;} 
 509   1      }
 510          
 511          void Calculator_Proc(void){
 512   1        if (mode != Calculator) {return;}
 513   1      }
 514          
 515          void DS18B20_Test(void)
 516          {
 517   1          float temp_value;
 518   1          char temp_string[16];
 519   1          
 520   1          // 1. å¯åŠ¨æ¸©åº¦è½¬æ¢
 521   1          DS18B20_ConvertT();
 522   1          
 523   1          // 2. ç­‰å¾…è½¬æ¢å®Œæˆ (DS18B20éœ€è¦çº¦750ms)
 524   1          Delay(750);
 525   1          
 526   1          // 3. è¯»å–æ¸©åº¦å€¼
 527   1          temp_value = DS18B20_ReadT();
 528   1          
 529   1          // 4. å°†æ¸©åº¦å€¼æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
 530   1          //    æ³¨æ„ï¼šKeil C51çš„sprintfé»˜è®¤å¯èƒ½ä¸æ”¯æŒ%fæµ®ç‚¹æ•°æ ¼å¼
 531   1          //    å¦‚æœæ˜¾ç¤ºä¸æ­£å¸¸ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢æˆ–æ›´æ”¹ç¼–è¯‘å™¨è®¾ç½®
 532   1          // sprintf(temp_string, "Temp: %.2f C", temp_value); // ç§»é™¤
 533   1          
 534   1          // 5. åœ¨LCDä¸Šæ˜¾ç¤ºç»“æœ
 535   1          LCD_ShowString(1, 1, "DS18B20 Test:");
 536   1          // LCD_ShowString(2, 1, "                "); // å…ˆæ¸…ç©ºç¬¬äºŒè¡Œ
 537   1          // LCD_ShowString(2, 1, temp_string);
 538   1      }
*** WARNING C280 IN LINE 518 OF main.c: 'temp_string': unreferenced local variable
 539          
 540          void main()
 541          {
 542   1      // ... (ä¿æŒåŸæ ·)
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 13:46:19 PAGE 10  

 543   1        AT24C02_clearTime();  // æ¸…é™¤ EEPROM ä¸­çš„æ—¶é—´æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
 544   1        DS18B20_ConvertT();
 545   1        Delay(750);
 546   1        Temperature = (int)DS18B20_ReadT();
 547   1        Temperature_Point = (int)(DS18B20_ReadT() * 100) % 100;
 548   1        Calendar_Init();
 549   1        LCD_Init();
 550   1        IR_Init();
 551   1        Motor_Init();
 552   1        // // LCD1602_Test();
 553   1        while(1)
 554   1        {
 555   2          IR_Data_Proc();
 556   2          Mode_Change();
 557   2      
 558   2          Calendar_Proc();
 559   2          Safe_Proc();
 560   2          Calculator_Proc();
 561   2      
 562   2          // DS18B20_Test();
 563   2              // Delay(1000); // æ¯éš”1ç§’æµ‹è¯•ä¸€æ¬¡
 564   2        }
 565   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1740    ----
   CONSTANT SIZE    =     55    ----
   XDATA SIZE       =     77    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4      34
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
