C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          // --- START OF FILE main.c ---
   2          
   3          #include <REGX52.H>
   4          #include "Delay.h"
   5          #include "Key.h"
   6          #include "Nixie.h"
   7          #include "Motor.h"
   8          #include "IR.h"
   9          #include "LCD1602.h"
  10          #include "Buzzer.h"
  11          #include <STDIO.H> // **ç§»é™¤æˆ–æ³¨é‡Šæ‰æ­¤è¡Œä»¥èŠ‚çœå†…å­˜ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†ä½¿ç”¨ sprintf**
  12          #include "DS1302.h"
  13          // #include "string.h" // **ç§»é™¤æˆ–æ³¨é‡Šæ‰æ­¤è¡Œä»¥èŠ‚çœå†…å­˜ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†ä½¿ç”¨ string.h å‡
             -½æ•°**
  14          #include "DS18B20.h"
  15          #include "AT24C02.h"
  16          #include "Timer0.h"
  17          #include "Timer1.h"
  18          
  19          /*PD*/
  20          #define LINE_MAX_LENGTH 16
  21          // ç›®æ ‡è¾“å…¥é•¿åº¦ï¼šå¹´(2)æœˆ(2)æ—¥(2)æ—¶(2)åˆ†(2)ç§’(2) = 12ä½æ•°å­—
  22          #define CALENDAR_INPUT_LEN 12 
  23          
  24          /*PD End*/
  25          /*PV*/
  26          // ... (ä¿æŒåŸæ ·)
  27          unsigned char Time_5s_Count = 0;    // ç”¨äº5ç§’æ¸©åº¦ä»»åŠ¡
  28          
  29          bit Flag_100ms_Task = 0;  // 100æ¯«ç§’ä»»åŠ¡ï¼ˆDS1302è¯»å–ã€LCDåˆ·æ–°ï¼ˆæ–°ï¼‰ï¼‰
  30          bit Flag_500ms_Task = 0;  // 500æ¯«ç§’ä»»åŠ¡ï¼ˆè®¾ç½®é—ªçƒï¼‰
  31          bit Flag_1s_Task = 0;       // 1ç§’ä»»åŠ¡ï¼ˆDS1302è¯»å–ã€LCDåˆ·æ–°ï¼‰
  32          bit Flag_5s_Task = 0;       // 5ç§’ä»»åŠ¡ï¼ˆDS18B20å¼€å§‹è½¬æ¢ï¼‰
  33          bit Flag_750ms_Ready = 0;   // DS18B20 750ms è½¬æ¢å®Œæˆæ ‡å¿—
  34          
  35          // DS18B20 çŠ¶æ€æœº
  36          char Temp_State = 0; // 0: Idle, 1: Convert Started, 2: Read Value
  37          
  38          typedef enum {
  39            Calendar,
  40            Safe,
  41            Calculator
  42          } Mode;
  43          Mode mode=Calendar;
  44          
  45          
  46          
  47          unsigned char IR_Cmd=0;
  48          
  49          xdata char Init_Time[]={19,12,31,23,59,0,2};  //åˆå§‹æ—¶é—´
  50          xdata char Set_Time[7];
  51          xdata char Plause_Time[7];
  52          xdata char L1_String[LINE_MAX_LENGTH]="";
  53          xdata char L2_String[LINE_MAX_LENGTH]="";
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 2   

  54          
  55          xdata int Temperature = 20; // ç”¨äºå­˜å‚¨è¯»å–çš„æ¸©åº¦å€¼
  56          xdata int Temperature_Point = 0; // ç”¨äºå­˜å‚¨æ¸©åº¦çš„å°æ•°éƒ¨åˆ†
  57          
  58          #define MAX_INPUT_DIGITS 16 // æœ€å¤§æ”¯æŒ16ä½æ•°å­—è¾“å…¥
  59          
  60          // è¾“å…¥ç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨è¾“å…¥çŠ¶æ€
  61          typedef struct {
  62              unsigned char Digit_Buffer[MAX_INPUT_DIGITS]; // å­˜å‚¨è¾“å…¥çš„æ•°å­—ï¼ˆ0-9çš„æ•°å€¼ï¼‰
  63              unsigned char Target_Length;                  // ç›®æ ‡è¾“å…¥é•¿åº¦
  64              unsigned char Current_Cursor;                 // å½“å‰å…‰æ ‡ä½ç½® (0 åˆ° Target_Length - 1)
  65              unsigned char Input_Finished;                  // è¾“å…¥å®Œæˆæ ‡å¿— (é€šå¸¸ç”±ç¡®è®¤é”®è®¾ç½®)
  66              unsigned char Blinking_State;                  // ç”¨äºé—ªçƒæ˜¾ç¤ºçš„æ ‡å¿—
  67          } IR_Input_State;
  68          
  69          // å…¨å±€å˜é‡ï¼Œç”¨äºä¿å­˜å½“å‰è¾“å…¥çŠ¶æ€
  70          xdata IR_Input_State Current_Input;
  71          
  72          bit Cal_Mode = 0; // 0:Display, 1:Set
  73          
  74          /*PV End*/
  75          
  76          /*Module Code*/
  77          // ... (AT24C02_clearTime, LCD1602_Test, IR_Data_Proc, Mode_Change, IR_Cmd_To_Digit ä¿æŒåŸæ ·)
  78          
  79          void AT24C02_clearTime(void){
  80   1        unsigned char i;
  81   1        for(i=0; i<7; i++){
  82   2          AT24C02_WriteByte(0x00 + i, 0x00);  
  83   2          Delay(5);
  84   2        }
  85   1      }
  86          void LCD1602_Test(void){
  87   1        LCD_ShowString(1,1,"Hello,World!    ");
  88   1        LCD_ShowString(2,1,"LCD1602 Test    ");
  89   1      }
  90          
  91          void IR_Data_Proc(void)
  92          {
  93   1        if (IR_GetDataFlag()){IR_Cmd=IR_GetCommand();}
  94   1      }
  95          void Mode_Change(void){
  96   1        if (IR_Cmd == IR_MODE){
  97   2          mode = (Mode)((mode + 1) % 3);
  98   2          IR_Cmd = 0;
  99   2        }else if (IR_Cmd == IR_POWER){
 100   2          mode = Calendar;  //é‡ç½®
 101   2          IR_Cmd = 0;
 102   2        }
 103   1      }
 104          
 105          // å°†çº¢å¤–å‘½ä»¤è½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­— (0-9)ï¼Œå¦‚æœä¸æ˜¯æ•°å­—åˆ™è¿”å› 0xFF
 106          unsigned char IR_Cmd_To_Digit(unsigned char cmd) {
 107   1          switch (cmd) {
 108   2              case IR_0: return 0;
 109   2              case IR_1: return 1;
 110   2              case IR_2: return 2;
 111   2              case IR_3: return 3;
 112   2              case IR_4: return 4;
 113   2              case IR_5: return 5;
 114   2              case IR_6: return 6;
 115   2              case IR_7: return 7;
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 3   

 116   2              case IR_8: return 8;
 117   2              case IR_9: return 9;
 118   2              default: return 0xFF; // è¿”å›æ— æ•ˆå€¼
 119   2          }
 120   1      }
 121          
 122          void Calendar_Init(void){
 123   1          unsigned char i;
 124   1        DS1302_Init();
 125   1        // EEPROM è¯»æ—¶é—´
 126   1          for(i=0; i<7; i++){
 127   2              DS1302_Time[i] = AT24C02_ReadByte(0x00 + i);
 128   2          }
 129   1          
 130   1          // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
 131   1          if (DS1302_Time[0] == 0x00) { 
 132   2              const char code Init_Time[] = {19,12,31,23,59,0,2}; 
 133   2              for(i=0; i<sizeof(Init_Time); i++){
 134   3                  DS1302_Time[i] = Init_Time[i];
 135   3              }
 136   2          }
 137   1          // è®¾ç½®æ—¶é—´åˆ° DS1302
 138   1        DS1302_SetTime();
 139   1          
 140   1        // å¤‡ä»½æ—¶é—´åˆ° EEPROM
 141   1          for(i=0; i<7; i++){
 142   2              AT24C02_WriteByte(0x00 + i, DS1302_Time[i]); 
 143   2              Delay(5);
 144   2          }
 145   1      }
 146          
 147          // **ä¿®æ”¹ï¼šä½¿ç”¨æ‰‹åŠ¨ASCIIè½¬æ¢ï¼Œç§»é™¤ sprintf**
 148          void Calendar_Disp(void){
 149   1          unsigned char i, j;
 150   1        DS1302_ReadTime(); // ä»DS1302è¯»å–æ—¶é—´
 151   1          
 152   1          // ====== L1: 20YY-MM-DD (16 chars) ======
 153   1          L1_String[0] = '2'; L1_String[1] = '0';
 154   1          L1_String[4] = '-'; L1_String[7] = '-';
 155   1          
 156   1          // YY (i=0, L1_String index 2,3)
 157   1          L1_String[2] = DS1302_Time[0]/10 + '0';
 158   1          L1_String[3] = DS1302_Time[0]%10 + '0';
 159   1          
 160   1          // MM (i=1, L1_String index 5,6)
 161   1          L1_String[5] = DS1302_Time[1]/10 + '0';
 162   1          L1_String[6] = DS1302_Time[1]%10 + '0';
 163   1          
 164   1          // DD (i=2, L1_String index 8,9)
 165   1          L1_String[8] = DS1302_Time[2]/10 + '0';
 166   1          L1_String[9] = DS1302_Time[2]%10 + '0';
 167   1          
 168   1          // å¡«å……å‰©ä½™ç©ºæ ¼
 169   1          for (i = 10; i < LINE_MAX_LENGTH; i++) { L1_String[i] = ' '; }
 170   1          L1_String[LINE_MAX_LENGTH-1] = '\0';
 171   1          
 172   1        LCD_ShowString(1,1,L1_String);
 173   1      
 174   1          // ====== L2: HH:mm:ss  Temp.Temp_Point C (16 chars) ======
 175   1          L2_String[2] = ':'; L2_String[5] = ':';
 176   1          
 177   1          // HH (i=3, L2_String index 0,1)
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 4   

 178   1          L2_String[0] = DS1302_Time[3]/10 + '0';
 179   1          L2_String[1] = DS1302_Time[3]%10 + '0';
 180   1          
 181   1          // mm (i=4, L2_String index 3,4)
 182   1          L2_String[3] = DS1302_Time[4]/10 + '0';
 183   1          L2_String[4] = DS1302_Time[4]%10 + '0';
 184   1          
 185   1          // ss (i=5, L2_String index 6,7)
 186   1          L2_String[6] = DS1302_Time[5]/10 + '0';
 187   1          L2_String[7] = DS1302_Time[5]%10 + '0';
 188   1      
 189   1          L2_String[8] = ' ';
 190   1          L2_String[9] = ' ';
 191   1          
 192   1          // Temp (L2_String index 10,11)
 193   1          // å‡è®¾ Temperature <= 99
 194   1          L2_String[10] = Temperature/10 + '0';
 195   1          L2_String[11] = Temperature%10 + '0';
 196   1          
 197   1          L2_String[12] = '.';
 198   1          
 199   1          // Temp_Point (L2_String index 13,14)
 200   1          L2_String[13] = Temperature_Point/10 + '0';
 201   1          L2_String[14] = Temperature_Point%10 + '0';
 202   1          
 203   1          L2_String[15] = 'C';
 204   1          L2_String[LINE_MAX_LENGTH] = '\0'; // ç¡®ä¿å­—ç¬¦ä¸²æ­£ç¡®ç»ˆæ­¢
 205   1          
 206   1        LCD_ShowString(2,1,L2_String);
 207   1      }
*** WARNING C280 IN LINE 149 OF main.c: 'j': unreferenced local variable
 208          
 209          void Time_Backup(void){
 210   1      // ... (ä¿æŒåŸæ ·)
 211   1        //æ¯ç§’å¤‡ä»½ç§’
 212   1        AT24C02_WriteByte(0x05, DS1302_Time[5]);
 213   1        // Delay(5);
 214   1        //æ¯åˆ†é’Ÿå¤‡ä»½åˆ†
 215   1        if (DS1302_Time[5] == 0) {
 216   2          AT24C02_WriteByte(0x04, DS1302_Time[4]);
 217   2          // Delay(5);
 218   2        }
 219   1        //æ¯å°æ—¶å¤‡ä»½æ—¶
 220   1        if (DS1302_Time[4] == 0 && DS1302_Time[5] == 0) {
 221   2          AT24C02_WriteByte(0x03, DS1302_Time[3]);
 222   2          // Delay(5);
 223   2        }
 224   1      }
 225          
 226          /**
 227           * @brief åˆå§‹åŒ–çº¢å¤–è¾“å…¥æ¨¡å— åˆå§‹åŒ–é•¿åº¦ã€åˆå§‹å€¼ã€å…‰æ ‡ä½ç½®ã€è¾“å…¥çŠ¶æ€ç­‰
 228           * @param Target_Length ç›®æ ‡è¾“å…¥çš„æ•°å­—ä½æ•° (ä¾‹å¦‚ï¼šæ—¥å†æ—¶é—´è®¾ç½®æ€»å…±14ä½)
 229           * @param Initial_Values å¯é€‰çš„åˆå§‹å€¼æ•°ç»„ (å¦‚æœéœ€è¦é¢„å¡«å……)ï¼Œå¯ä¼ å…¥ NULL
 230           */
 231          void IR_Input_Init(unsigned char Target_Length, unsigned char *Initial_Values)
 232          {
 233   1          unsigned char i;
 234   1          
 235   1          // é™åˆ¶æœ€å¤§é•¿åº¦
 236   1          if (Target_Length > MAX_INPUT_DIGITS) {
 237   2              Target_Length = MAX_INPUT_DIGITS;
 238   2          }
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 5   

 239   1      
 240   1          Current_Input.Target_Length = Target_Length; // ç›®æ ‡é•¿åº¦ï¼š12
 241   1          Current_Input.Current_Cursor = 0; // å…‰æ ‡ä»ç¬¬ä¸€ä½å¼€å§‹
 242   1          Current_Input.Input_Finished = 0; // è¾“å…¥æœªå®Œæˆ
 243   1      
 244   1          // å¾ªç¯6æ¬¡ï¼Œå¯¹åº”6ä¸ªæ—¶é—´åˆ†é‡ (å¹´,æœˆ,æ—¥,æ—¶,åˆ†,ç§’)
 245   1          for (i = 0; i < 6; i++) 
 246   1          {
 247   2              // Target_Length æ˜¯ 12ã€‚æˆ‘ä»¬æ£€æŸ¥ i*2 æ˜¯å¦åœ¨èŒƒå›´å†…
 248   2              if (i*2 < Target_Length && Initial_Values != NULL) {
 249   3                  // å°†ä¸¤ä½æ•°ï¼ˆä¾‹å¦‚ 19ï¼‰æ‹†åˆ†æˆä¸¤ä¸ªæ•°å­—ï¼ˆ1 å’Œ 9ï¼‰
 250   3                  Current_Input.Digit_Buffer[i*2] = Initial_Values[i]/10;
 251   3            Current_Input.Digit_Buffer[i*2+1] = Initial_Values[i]%10;
 252   3              } else {
 253   3                  // å¦åˆ™åˆå§‹åŒ–ä¸º 0
 254   3                  Current_Input.Digit_Buffer[i*2] = 0; 
 255   3            Current_Input.Digit_Buffer[i*2+1] = 0;
 256   3              }
 257   2          }
 258   1      }
 259          
 260          void IR_Input_Proc(unsigned char ir_digit){
 261   1        if(Current_Input.Target_Length == 0 || Current_Input.Input_Finished){
 262   2          return; // å¦‚æœæ²¡æœ‰è®¾ç½®ç›®æ ‡é•¿åº¦æˆ–è¾“å…¥å·²å®Œæˆï¼Œç›´æ¥è¿”å›
 263   2        }
 264   1        
 265   1          // 1. å­˜å‚¨æ–°çš„æ•°å­—
 266   1        Current_Input.Digit_Buffer[Current_Input.Current_Cursor] = ir_digit;
 267   1      
 268   1          // 2. ç§»åŠ¨å…‰æ ‡
 269   1        Current_Input.Current_Cursor++;
 270   1      
 271   1          // 3. æ£€æŸ¥æ˜¯å¦å®Œæˆè¾“å…¥
 272   1          if (Current_Input.Current_Cursor >= Current_Input.Target_Length) {
 273   2              Current_Input.Input_Finished = 1; // 12ä½è¾“å…¥å®Œæˆ
 274   2              Current_Input.Current_Cursor = 0; // å…‰æ ‡å½’é›¶
 275   2          }
 276   1      }
 277          
 278          // **æ–°å¢/ä¿®æ”¹ï¼šä½¿ç”¨æ‰‹åŠ¨ç´¢å¼•å’Œèµ‹å€¼ï¼Œç§»é™¤ strlen**
 279          void Calendar_Build_String_Set(bit Blink_State)
 280          {
 281   1          unsigned char i;
 282   1          unsigned char digit;
 283   1          unsigned char L1_Cursor = 0;
 284   1          unsigned char L2_Cursor = 0;
 285   1          
 286   1          // ====== L1: 20YY-MM-DD (16 chars) ======
 287   1          // 20
 288   1          L1_String[L1_Cursor++] = '2'; 
 289   1          L1_String[L1_Cursor++] = '0';
 290   1          
 291   1          for (i = 0; i < 6; i++) // Digits 0 to 5 (YY MM DD)
 292   1          {
 293   2              digit = Current_Input.Digit_Buffer[i];
 294   2              
 295   2              // é—ªçƒé€»è¾‘: å¦‚æœå½“å‰å…‰æ ‡ä½ç½® i ä¸” Blink_State ä¸ºçœŸï¼Œåˆ™æ˜¾ç¤ºç©ºæ ¼
 296   2              if (i == Current_Input.Current_Cursor && Blink_State) {
 297   3                  L1_String[L1_Cursor++] = ' ';
 298   3              } else {
 299   3                  L1_String[L1_Cursor++] = '0' + digit;
 300   3              }
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 6   

 301   2              
 302   2              // æ·»åŠ åˆ†éš”ç¬¦ (åœ¨ YY2 (i=1) å’Œ MM2 (i=3) ä¹‹å)
 303   2              if (i == 1 || i == 3) {
 304   3                  L1_String[L1_Cursor++] = '-';
 305   3              }
 306   2          }
 307   1          // å¡«å……L1é•¿åº¦
 308   1          while (L1_Cursor < LINE_MAX_LENGTH) { L1_String[L1_Cursor++] = ' '; }
 309   1          L1_String[LINE_MAX_LENGTH-1] = '\0'; // å­—ç¬¦ä¸²ç»“æŸç¬¦
 310   1      
 311   1          // ====== L2: HH:mm:ss (16 chars) ======
 312   1          for (i = 6; i < 12; i++) // Digits 6 to 11 (HH mm ss)
 313   1          {
 314   2              digit = Current_Input.Digit_Buffer[i];
 315   2      
 316   2              // é—ªçƒé€»è¾‘
 317   2              if (i == Current_Input.Current_Cursor && Blink_State) {
 318   3                  L2_String[L2_Cursor++] = ' ';
 319   3              } else {
 320   3                  L2_String[L2_Cursor++] = '0' + digit;
 321   3              }
 322   2      
 323   2              // æ·»åŠ åˆ†éš”ç¬¦ (åœ¨ HH2 (i=7) å’Œ mm2 (i=9) ä¹‹å)
 324   2              if (i == 7 || i == 9) {
 325   3                  L2_String[L2_Cursor++] = ':';
 326   3              }
 327   2          }
 328   1          // å¡«å……L2é•¿åº¦
 329   1          while (L2_Cursor < LINE_MAX_LENGTH) { L2_String[L2_Cursor++] = ' '; }
 330   1          L2_String[LINE_MAX_LENGTH-1] = '\0'; // å­—ç¬¦ä¸²ç»“æŸç¬¦
 331   1      }
 332          
 333          
 334          void Calendar_Set(void){
 335   1        static bit Cal_Set_Init_Flag = 0; // 0:æœªåˆå§‹åŒ–, 1:å·²åˆå§‹åŒ–
 336   1        unsigned char i;
 337   1        unsigned char ir_digit;
 338   1      
 339   1        
 340   1        if (!Cal_Set_Init_Flag) {
 341   2          DS1302_ReadTime(); // ä»DS1302è¯»å–æ—¶é—´
 342   2          for (i = 0; i < 7; i++){
 343   3            Plause_Time[i] = DS1302_Time[i];
 344   3          }
 345   2          IR_Input_Init(CALENDAR_INPUT_LEN, Plause_Time); // åˆå§‹åŒ–çº¢å¤–è¾“å…¥æ¨¡å—ï¼Œç›®æ ‡é•¿åº¦ä¸º12ï¼Œåˆ
             -å§‹å€¼ä¸ºå½“å‰æ—¶é—´
 346   2          Cal_Set_Init_Flag = 1;
 347   2              
 348   2              Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–°æ˜¾ç¤º
 349   2        }
 350   1          
 351   1          // 1. å¤„ç†çº¢å¤–è¾“å…¥
 352   1        ir_digit = IR_Cmd_To_Digit(IR_Cmd);
 353   1        if (ir_digit != 0xFF) { // ä»…å½“çº¢å¤–è¾“å…¥æ˜¯æœ‰æ•ˆæ•°å­—æ—¶æ‰å¤„ç†
 354   2          IR_Input_Proc(ir_digit); // å¤„ç†çº¢å¤–è¾“å…¥ï¼šå­˜å…¥Digit_Bufferï¼Œç§»åŠ¨å…‰æ ‡
 355   2          IR_Cmd = 0; // æ¸…é™¤å‘½ä»¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†
 356   2              Flag_100ms_Task = 1; // ç«‹å³åˆ·æ–°æ˜¾ç¤º
 357   2        }
 358   1          // // å¤„ç†ç¡®è®¤é”® (ä¾‹å¦‚ IR_OK) - å¼ºåˆ¶å®Œæˆè¾“å…¥å¹¶ä¿å­˜
 359   1          // if (IR_Cmd == IR_EQ) {
 360   1          //     Current_Input.Input_Finished = 1;
 361   1          //     IR_Cmd = 0;
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 7   

 362   1          // }
 363   1        
 364   1          // 2. å‘¨æœŸæ€§åˆ·æ–°æ˜¾ç¤º (100ms ä»»åŠ¡)
 365   1          if (Flag_100ms_Task) {
 366   2              
 367   2              // 3. å¤„ç†æ˜¾ç¤ºï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶åœ¨å…‰æ ‡ä½ç½®åº”ç”¨é—ªçƒ
 368   2              Calendar_Build_String_Set(Flag_500ms_Task); // **ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„æ—  strlen å‡½æ•°**
 369   2      
 370   2              // æ˜¾ç¤ºå­—ç¬¦ä¸²
 371   2              LCD_ShowString(1,1,L1_String);
 372   2              LCD_ShowString(2,1,L2_String);
 373   2              
 374   2              Flag_100ms_Task = 0;
 375   2          }
 376   1      
 377   1      
 378   1        // 4. è¾“å…¥å®Œæˆåçš„æ•°æ®è½¬æ¢å’Œä¿å­˜
 379   1        if (Current_Input.Input_Finished)
 380   1        {
 381   2          // è¾“å…¥å®Œæˆï¼Œå°† 12 ä½æ•°å­—é‡æ–°ç»„åˆæˆ 6 ä¸ªæ—¶é—´åˆ†é‡
 382   2          for (i = 0; i < 6; i++)
 383   2          {
 384   3                  // Set_Time[0]=D[0]*10+D[1], Set_Time[1]=D[2]*10+D[3], ...
 385   3            Set_Time[i] = Current_Input.Digit_Buffer[i * 2] * 10 + Current_Input.Digit_Buffer[i * 2 + 1];
 386   3          }
 387   2              // æ˜ŸæœŸä¿æŒä¸å˜
 388   2              Set_Time[6] = Plause_Time[6]; 
 389   2      
 390   2          // æ›´æ–° DS1302_Time æ•°ç»„
 391   2          for(i=0; i<7; i++){
 392   3            DS1302_Time[i] = Set_Time[i];
 393   3          }
 394   2              
 395   2          // è®¾ç½®æ—¶é—´åˆ°DS1302èŠ¯ç‰‡
 396   2          DS1302_SetTime();
 397   2              Delay(10); // ç­‰å¾…DS1302å†™å…¥å®Œæˆ
 398   2              
 399   2              // è¯»å–éªŒè¯ï¼šä»DS1302è¯»å›æ—¶é—´ï¼Œç¡®ä¿å†™å…¥æˆåŠŸ
 400   2              DS1302_ReadTime();
 401   2              
 402   2              // å¤‡ä»½æ—¶é—´åˆ° EEPROM
 403   2              for(i=0; i<7; i++){
 404   3                  AT24C02_WriteByte(0x00 + i, DS1302_Time[i]); 
 405   3                  Delay(5);
 406   3              }
 407   2      
 408   2          Cal_Set_Init_Flag = 0; // é‡ç½®åˆå§‹åŒ–æ ‡å¿—ï¼Œä¸‹æ¬¡è¿›å…¥é‡æ–°åŠ è½½æ—¶é—´
 409   2              Current_Input.Input_Finished = 0; // é‡ç½®è¾“å…¥å®Œæˆæ ‡å¿—
 410   2              Cal_Mode = 0; // åˆ‡æ¢å›æ˜¾ç¤ºæ¨¡å¼
 411   2        }
 412   1        
 413   1      }
 414          
 415          /*Module Code End*/
 416          
 417          /*Proc Code*/
 418          void Temp_Proc(void){
 419   1          if (mode != Calendar) return;
 420   1      
 421   1          if (Temp_State == 0) { // Idle çŠ¶æ€
 422   2              if (Flag_5s_Task) {
 423   3                  // å¼€å§‹æ¸©åº¦è½¬æ¢ï¼Œä¸é˜»å¡
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 8   

 424   3                  P3_5 = 1;
 425   3                  DS18B20_ConvertT(); // å‡è®¾è¿™ä¸ªå‡½æ•°åªæ˜¯å‘é€å¯åŠ¨å‘½ä»¤
 426   3                  Flag_5s_Task = 0;
 427   3                  Temp_State = 1; // è¿›å…¥è½¬æ¢ä¸­çŠ¶æ€
 428   3              }
 429   2          } else if (Temp_State == 1) { // è½¬æ¢ä¸­çŠ¶æ€
 430   2              if (Flag_750ms_Ready) {
 431   3            float temp;
 432   3                  // 750ms ç­‰å¾…å®Œæˆï¼Œè¯»å–æ¸©åº¦
 433   3                  P3_5 = 1;
 434   3            temp = DS18B20_ReadT();
 435   3            Temperature_Point = (int)(temp * 100) % 100;
 436   3            Temperature = (int)temp;
 437   3      
 438   3                  Flag_750ms_Ready = 0;
 439   3                  Temp_State = 0; // å›åˆ° Idle çŠ¶æ€
 440   3              }
 441   2          }
 442   1      }
 443          
 444          void Calendar_Proc(void){
 445   1        if (mode != Calendar) {return;}
 446   1          
 447   1          if (IR_Cmd == IR_START_STOP) {
 448   2              Cal_Mode = !Cal_Mode; // åˆ‡æ¢æ¨¡å¼
 449   2              IR_Cmd = 0; // æ¸…é™¤å‘½ä»¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†
 450   2          }
 451   1              
 452   1        // 2. å‘¨æœŸæ€§ä»»åŠ¡å¤„ç†
 453   1          if (Cal_Mode) {
 454   2              // è®¾ç½®æ¨¡å¼
 455   2              // --- A. æŒ‰é”®å¤„ç† (åªå¤„ç†ä¿å­˜é”®) ---
 456   2              if (IR_Cmd == IR_EQ) {
 457   3                  Current_Input.Input_Finished = 1;
 458   3                  IR_Cmd = 0; // æ¸…é™¤å‘½ä»¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†
 459   3              }
 460   2              
 461   2              // --- B. è®¾ç½®é€»è¾‘ (åŒ…æ‹¬è¾“å…¥å’Œä¿å­˜) ---
 462   2          Calendar_Set();
 463   2      
 464   2              // 500ms ä»»åŠ¡ï¼šç”¨äºé—ªçƒåˆ‡æ¢
 465   2              if (Flag_500ms_Task) {
 466   3                  Flag_500ms_Task = 0;
 467   3              }
 468   2              
 469   2        } else {
 470   2              // æ˜¾ç¤ºæ¨¡å¼
 471   2              // --- E. æ˜¾ç¤ºé€»è¾‘ ---
 472   2              if (Flag_100ms_Task) {
 473   3                  Calendar_Disp();
 474   3            Flag_100ms_Task = 0; 
 475   3              }
 476   2              // ... (Time_Backup å’Œ Temp_Proc ä¿æŒä¸å˜)
 477   2          if (Flag_1s_Task) {
 478   3            Time_Backup(); // æ¯ç§’å¤‡ä»½æ—¶é—´åˆ° EEPROM
 479   3            Flag_1s_Task = 0;
 480   3          }
 481   2              
 482   2              // 5ç§’ä»»åŠ¡ï¼šæ¸©åº¦è½¬æ¢å’Œè¯»å– (é€šè¿‡ Temp_Proc çŠ¶æ€æœºå¤„ç†)
 483   2              Temp_Proc();        
 484   2        }
 485   1      }
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 9   

 486          // ... (Safe_Proc, Calculator_Proc, DS18B20_Test ä¿æŒåŸæ ·)
 487          void Safe_Proc(void){
 488   1        if (mode != Safe) {return;} 
 489   1      }
 490          
 491          void Calculator_Proc(void){
 492   1        if (mode != Calculator) {return;}
 493   1      }
 494          
 495          void DS18B20_Test(void)
 496          {
 497   1          float temp_value;
 498   1          char temp_string[16];
 499   1          
 500   1          // 1. å¯åŠ¨æ¸©åº¦è½¬æ¢
 501   1          DS18B20_ConvertT();
 502   1          
 503   1          // 2. ç­‰å¾…è½¬æ¢å®Œæˆ (DS18B20éœ€è¦çº¦750ms)
 504   1          Delay(750);
 505   1          
 506   1          // 3. è¯»å–æ¸©åº¦å€¼
 507   1          temp_value = DS18B20_ReadT();
 508   1          
 509   1          // 4. å°†æ¸©åº¦å€¼æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
 510   1          //    æ³¨æ„ï¼šKeil C51çš„sprintfé»˜è®¤å¯èƒ½ä¸æ”¯æŒ%fæµ®ç‚¹æ•°æ ¼å¼
 511   1          //    å¦‚æœæ˜¾ç¤ºä¸æ­£å¸¸ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢æˆ–æ›´æ”¹ç¼–è¯‘å™¨è®¾ç½®
 512   1          // sprintf(temp_string, "Temp: %.2f C", temp_value); // ç§»é™¤
 513   1          
 514   1          // 5. åœ¨LCDä¸Šæ˜¾ç¤ºç»“æœ
 515   1          LCD_ShowString(1, 1, "DS18B20 Test:");
 516   1          // LCD_ShowString(2, 1, "                "); // å…ˆæ¸…ç©ºç¬¬äºŒè¡Œ
 517   1          // LCD_ShowString(2, 1, temp_string);
 518   1      }
*** WARNING C280 IN LINE 498 OF main.c: 'temp_string': unreferenced local variable
 519          
 520          void main()
 521          {
 522   1      // ... (ä¿æŒåŸæ ·)
 523   1        // AT24C02_clearTime();  // æ¸…é™¤ EEPROM ä¸­çš„æ—¶é—´æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°åˆå§‹åŒ– - æ³¨é‡Šæ‰ä»¥ä¿ç•™
             -è®¾ç½®çš„æ—¶é—´
 524   1        DS18B20_ConvertT();
 525   1        Delay(750);
 526   1        Temperature = (int)DS18B20_ReadT();
 527   1        Temperature_Point = (int)(DS18B20_ReadT() * 100) % 100;
 528   1        Calendar_Init();
 529   1        LCD_Init();
 530   1        IR_Init();
 531   1        Motor_Init();
 532   1        // // LCD1602_Test();
 533   1        while(1)
 534   1        {
 535   2          IR_Data_Proc();
 536   2          Mode_Change();
 537   2      
 538   2          Calendar_Proc();
 539   2          Safe_Proc();
 540   2          Calculator_Proc();
 541   2      
 542   2          // DS18B20_Test();
 543   2              // Delay(1000); // æ¯éš”1ç§’æµ‹è¯•ä¸€æ¬¡
 544   2        }
 545   1      }
C51 COMPILER V9.54   MAIN                                                                  10/14/2025 19:47:16 PAGE 10  



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1709    ----
   CONSTANT SIZE    =     55    ----
   XDATA SIZE       =     77    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4      33
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
