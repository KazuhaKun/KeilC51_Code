# 系统重置功能说明

## ✅ 完成状态

**状态**: 已完成  
**日期**: 2025-10-15  
**编译**: 无错误 ✅

---

## 📋 功能概述

当用户按下红外遥控器的 **POWER** 键时，系统将执行完整重置，包括：

1. **模式重置**：切换到万年历模式
2. **时间重置**：恢复到 `2019年12月31日 23:59:00`
3. **密码重置**：密码恢复到 `00000000`（8个0）

### 功能流程

```
用户按下 POWER 键
    ↓
系统重置函数 (System_Reset)
    ↓
┌─────────────────────────────┐
│ 1. 模式重置为万年历          │
│ 2. 时间设置为 2019-12-31    │
│                23:59:00      │
│ 3. 密码设置为 00000000      │
│ 4. 保存到 DS1302           │
│ 5. 保存到 EEPROM           │
└─────────────────────────────┘
    ↓
LCD 显示 "System Reset!"
LCD 显示 "Time&PWD Reset"
    ↓
等待 2 秒
    ↓
返回万年历显示界面
```

---

## 🎯 重置内容详细说明

### 1. 模式重置

| 项目 | 重置前 | 重置后 |
|-----|--------|--------|
| 当前模式 | 可能在任意模式（Calendar/Safe/Calculator） | **Calendar（万年历）** |
| 万年历状态 | 可能在设置模式 | **显示模式** |
| 密码锁状态 | 可能在验证/设置状态 | - |
| 计算器状态 | 可能在计算中 | - |

### 2. 时间重置

| 时间项 | 重置值 | 说明 |
|-------|--------|------|
| 年份 | 19 | 2019年 |
| 月份 | 12 | 12月 |
| 日期 | 31 | 31日 |
| 小时 | 23 | 23点 |
| 分钟 | 59 | 59分 |
| 秒数 | 0 | 00秒 |
| 星期 | 2 | 星期二 |

**LCD显示效果**：
```
第一行: 2019-12-31
第二行: 23:59:00  XX.XX°C
```

### 3. 密码重置

| 位数 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 |
|-----|---|---|---|---|---|---|---|---|
| 重置前 | ? | ? | ? | ? | ? | ? | ? | ? |
| 重置后 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |

**注意**：默认密码原本是 `12345678`，重置后变为 `00000000`

---

## 💻 代码实现

### System_Reset() 函数

```c
void System_Reset(void)
{
    unsigned char i;
    
    // 1. 重置模式为万年历
    mode = Calendar;
    Cal_Mode = 0;  // 显示模式
    
    // 2. 重置时间为 2019-12-31 23:59:00
    DS1302_Time[0] = 19;  // 年
    DS1302_Time[1] = 12;  // 月
    DS1302_Time[2] = 31;  // 日
    DS1302_Time[3] = 23;  // 时
    DS1302_Time[4] = 59;  // 分
    DS1302_Time[5] = 0;   // 秒
    DS1302_Time[6] = 2;   // 星期二
    
    // 设置时间到DS1302
    DS1302_SetTime();
    
    // 备份时间到EEPROM
    for(i = 0; i < 7; i++){
        AT24C02_WriteByte(0x00 + i, DS1302_Time[i]); 
        Delay(5);
    }
    
    // 3. 重置密码为 00000000
    for(i = 0; i < PASSWORD_LENGTH; i++){
        Saved_Password[i] = 0;  // 全部设为0
        AT24C02_WriteByte(EEPROM_PASSWORD_ADDR + i, 0);
        Delay(5);
    }
    
    // 4. 显示重置完成信息
    LCD_ShowString(1, 1, "System Reset!   ");
    LCD_ShowString(2, 1, "Time&PWD Reset  ");
    Delay(2000);  // 显示2秒
    
    // 5. 清除屏幕，准备显示万年历
    LCD_Init();
}
```

### Mode_Change() 函数（已更新）

```c
void Mode_Change(void){
    if (IR_Cmd == IR_MODE){
        mode = (Mode)((mode + 1) % 3);
        IR_Cmd = 0;
    }else if (IR_Cmd == IR_POWER){
        // 调用系统重置函数
        System_Reset();
        IR_Cmd = 0;
    }
}
```

---

## 🔌 EEPROM 存储更新

### 重置时写入的EEPROM地址

| 地址 | 内容 | 重置值 | 说明 |
|-----|------|--------|------|
| 0x00 | 年份 | 0x13 (19) | 2019年 |
| 0x01 | 月份 | 0x0C (12) | 12月 |
| 0x02 | 日期 | 0x1F (31) | 31日 |
| 0x03 | 小时 | 0x17 (23) | 23点 |
| 0x04 | 分钟 | 0x3B (59) | 59分 |
| 0x05 | 秒数 | 0x00 (0) | 00秒 |
| 0x06 | 星期 | 0x02 (2) | 星期二 |
| 0x10 | 密码位1 | 0x00 (0) | 第1位 |
| 0x11 | 密码位2 | 0x00 (0) | 第2位 |
| 0x12 | 密码位3 | 0x00 (0) | 第3位 |
| 0x13 | 密码位4 | 0x00 (0) | 第4位 |
| 0x14 | 密码位5 | 0x00 (0) | 第5位 |
| 0x15 | 密码位6 | 0x00 (0) | 第6位 |
| 0x16 | 密码位7 | 0x00 (0) | 第7位 |
| 0x17 | 密码位8 | 0x00 (0) | 第8位 |

**总写入次数**：15次（7次时间 + 8次密码）  
**每次写入延时**：5ms  
**总延时时间**：75ms + 2000ms（显示） = **约2.1秒**

---

## 🧪 功能测试

### 测试步骤

#### 场景1：从万年历模式重置

1. **初始状态**
   ```
   当前模式: Calendar（万年历）
   当前时间: 2025-10-15 14:30:25（假设）
   当前密码: 12345678（默认密码）
   ```

2. **按下 POWER 键**
   ```
   LCD第一行显示: "System Reset!"
   LCD第二行显示: "Time&PWD Reset"
   等待2秒
   ```

3. **检查结果**
   ```
   LCD第一行显示: "2019-12-31"
   LCD第二行显示: "23:59:00  XX.XX°C"
   
   等待1分钟后应显示:
   LCD第一行显示: "2020-01-01"
   LCD第二行显示: "00:00:00  XX.XX°C"
   ```

4. **验证密码重置**
   ```
   按 MODE 键 → 切换到 Safe 模式
   输入密码: 00000000
   按 EQ 键 → 应显示"Password OK!"并开门
   ```

---

#### 场景2：从密码锁模式重置

1. **初始状态**
   ```
   当前模式: Safe（密码锁）
   正在输入密码或验证密码
   ```

2. **按下 POWER 键**
   ```
   LCD第一行显示: "System Reset!"
   LCD第二行显示: "Time&PWD Reset"
   等待2秒
   ```

3. **检查结果**
   ```
   自动切换到万年历模式
   LCD显示: "2019-12-31"
            "23:59:00  XX.XX°C"
   ```

---

#### 场景3：从计算器模式重置

1. **初始状态**
   ```
   当前模式: Calculator（计算器）
   可能正在输入数字或显示结果
   ```

2. **按下 POWER 键**
   ```
   LCD第一行显示: "System Reset!"
   LCD第二行显示: "Time&PWD Reset"
   等待2秒
   ```

3. **检查结果**
   ```
   自动切换到万年历模式
   LCD显示: "2019-12-31"
            "23:59:00  XX.XX°C"
   ```

---

### 测试清单

| 检查项 | 预期结果 | 实际结果 |
|-------|---------|---------|
| 按POWER键触发 | 立即响应 | ⬜ |
| LCD显示重置信息 | "System Reset!"<br>"Time&PWD Reset" | ⬜ |
| 显示时长 | 2秒 | ⬜ |
| 模式切换 | 自动切换到万年历 | ⬜ |
| 时间重置 | 显示"2019-12-31 23:59:00" | ⬜ |
| 时间进位测试 | 1分钟后变为"2020-01-01 00:00:00" | ⬜ |
| 密码重置 | 输入"00000000"可通过验证 | ⬜ |
| EEPROM保存 | 断电重启后时间和密码保持 | ⬜ |

---

## 🔧 使用场景

### 场景1：测试时间进位功能

```
目的: 测试从2019年12月31日23:59:00到2020年1月1日00:00:00的进位
步骤:
  1. 按 POWER 键重置系统
  2. 等待约1分钟
  3. 观察时间是否正确进位
```

### 场景2：忘记密码

```
情况: 用户忘记了自己设置的密码
解决:
  1. 按 POWER 键重置系统
  2. 密码自动重置为 00000000
  3. 可以重新进入密码锁模式设置新密码
```

### 场景3：快速恢复出厂设置

```
情况: 需要将系统恢复到初始状态
操作:
  1. 按 POWER 键
  2. 系统自动恢复所有设置
  3. 时间: 2019-12-31 23:59:00
  4. 密码: 00000000
```

---

## ⚙️ 技术细节

### 重置时序

```
时间轴（ms）:  0    50    100   ...   2000  2100
              |-----|-----|------|-----|-----|
事件:         按键   写    写     显示   显示   返回
             触发  EEPROM EEPROM  信息   结束   万年历

Phase 1: 写入时间到EEPROM (7次 × 5ms = 35ms)
Phase 2: 写入密码到EEPROM (8次 × 5ms = 40ms)
Phase 3: 显示重置信息 (2000ms)
Phase 4: 清屏并返回万年历

总耗时: 约 2.1 秒
```

### DS1302时间设置

```c
// 重置时间数组
DS1302_Time[0] = 19;  // 年: 0x13
DS1302_Time[1] = 12;  // 月: 0x0C
DS1302_Time[2] = 31;  // 日: 0x1F
DS1302_Time[3] = 23;  // 时: 0x17
DS1302_Time[4] = 59;  // 分: 0x3B
DS1302_Time[5] = 0;   // 秒: 0x00
DS1302_Time[6] = 2;   // 周: 0x02

// DS1302_SetTime() 会自动进行BCD转换
// 实际写入DS1302的是BCD码
```

### 密码重置

```c
// 重置前（假设）: {1, 2, 3, 4, 5, 6, 7, 8}
// 重置后:        {0, 0, 0, 0, 0, 0, 0, 0}

for(i = 0; i < 8; i++){
    Saved_Password[i] = 0;
    AT24C02_WriteByte(0x10 + i, 0);
    Delay(5);
}
```

---

## 🎯 与其他功能的关系

### 1. 与万年历的关系

- 重置后自动切换到万年历模式
- 时间设置为测试进位的特殊时间点
- 温度显示功能不受影响

### 2. 与密码锁的关系

- 密码重置为 `00000000`
- 用户可以使用新密码登录
- 可以重新设置密码（按 START/STOP 切换到设置模式）

### 3. 与计算器的关系

- 计算器状态会被清除
- 重置后需要重新进入计算器模式才能使用

---

## 🔒 安全性考虑

### 优点

1. **快速恢复**：忘记密码时无需专业工具即可恢复
2. **测试友好**：方便测试时间进位等功能
3. **简单易用**：一键重置，无需复杂操作

### 注意事项

⚠️ **重置操作不可逆**：一旦重置，当前的时间和密码设置将丢失  
⚠️ **无二次确认**：直接按POWER键即重置，无确认步骤  
⚠️ **建议改进**：可以考虑添加长按确认机制

### 改进建议（可选）

```c
// 长按3秒确认重置
bit Power_Key_Pressed = 0;
unsigned int Power_Press_Time = 0;

void Mode_Change(void){
    if (IR_Cmd == IR_MODE){
        mode = (Mode)((mode + 1) % 3);
        IR_Cmd = 0;
    }else if (IR_Cmd == IR_POWER){
        if (!Power_Key_Pressed) {
            Power_Key_Pressed = 1;
            Power_Press_Time = 0;
            LCD_ShowString(1, 1, "Hold 3s to Reset");
        }
        IR_Cmd = 0;
    }
}

// 在定时器中断中
if (Power_Key_Pressed) {
    Power_Press_Time++;
    if (Power_Press_Time >= 3000) {  // 3秒
        System_Reset();
        Power_Key_Pressed = 0;
    }
}
```

---

## 📝 代码位置

| 文件 | 函数/变量 | 说明 |
|-----|----------|------|
| `main.c` | `System_Reset()` | 系统重置函数实现 |
| `main.c` | `Mode_Change()` | 调用重置函数 |
| `DS1302.c` | `DS1302_SetTime()` | 设置DS1302时间 |
| `AT24C02.c` | `AT24C02_WriteByte()` | 写入EEPROM |

---

## ✅ 完成清单

- [x] 实现 `System_Reset()` 函数
- [x] 更新 `Mode_Change()` 函数
- [x] 重置模式到万年历
- [x] 重置时间到 2019-12-31 23:59:00
- [x] 重置密码到 00000000
- [x] 保存到 DS1302
- [x] 保存到 EEPROM
- [x] 添加 LCD 提示信息
- [x] 代码编译无错误
- [ ] 硬件测试
- [ ] 时间进位验证
- [ ] 密码重置验证

---

## 🎓 总结

本次实现完成了系统重置功能，通过按下红外遥控器的 **POWER** 键，可以一键重置：

✅ **模式重置**：切换到万年历模式  
✅ **时间重置**：恢复到 2019-12-31 23:59:00（方便测试进位）  
✅ **密码重置**：恢复到 00000000（方便忘记密码时恢复）  
✅ **持久化**：所有数据保存到 EEPROM，断电不丢失  
✅ **用户友好**：LCD 显示重置信息，操作直观

这个功能特别适合：
- 测试时间进位功能
- 用户忘记密码时恢复
- 快速恢复到出厂设置

---

**版本**: v1.0  
**日期**: 2025-10-15  
**项目**: 多功能系统 - 系统重置功能  
**测试状态**: ✅ 代码完成，待硬件测试
