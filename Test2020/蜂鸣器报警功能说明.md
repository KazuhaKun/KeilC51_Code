# 蜂鸣器报警功能说明

## ✅ 完成状态

**状态**: 已完成  
**日期**: 2025-10-15  
**编译**: 无错误 ✅

---

## 📋 功能概述

在密码锁系统中，当用户输入错误的密码时，蜂鸣器将报警3秒以提示用户密码错误。

### 功能流程

```
用户输入密码 (8位)
    ↓
密码验证
    ↓
  错误？
    ↓
  是 → LCD显示"Wrong Password!"
       ↓
     LCD显示"Buzzer Alarm..."
       ↓
     蜂鸣器响3秒（频率约1kHz）
       ↓
     蜂鸣器停止
       ↓
     LCD显示"Alarm Stopped!"
       ↓
     返回密码输入界面
```

---

## 🔌 硬件连接

### 蜂鸣器接口

| 单片机引脚 | 蜂鸣器引脚 | 说明 |
|-----------|----------|------|
| P2.5 | I/O | 蜂鸣器控制信号 |
| VCC | VCC | 电源正极（5V或3.3V） |
| GND | GND | 电源地 |

### 蜂鸣器类型

**支持的蜂鸣器类型**：
- **无源蜂鸣器**（推荐）：需要PWM信号驱动，可调频率
- **有源蜂鸣器**：直接高/低电平控制，固定频率

**注意**：本代码使用翻转输出方式，适用于**无源蜂鸣器**。

---

## 💻 代码实现

### 1. 文件修改

| 文件 | 修改内容 | 状态 |
|-----|---------|------|
| `Buzzer.h` | 添加 `Buzzer_Alarm_3s()` 函数声明 | ✅ |
| `Buzzer.c` | 实现 `Buzzer_Alarm_3s()` 函数 | ✅ |
| `main.c` | 更新 `Buzzer_Alarm()` 调用实际蜂鸣器 | ✅ |

### 2. 核心函数

#### `Buzzer_Alarm_3s()` (Buzzer.c)

```c
void Buzzer_Alarm_3s(void)
{
    // 报警3秒，频率约1kHz
    Buzzer_Time(3000);
    
    // 确保蜂鸣器停止（输出低电平）
    Buzzer = 1;
}
```

**功能**：
- 蜂鸣器响3000ms（3秒）
- 频率：约1kHz（500us翻转周期）
- 自动停止并关闭蜂鸣器

#### `Buzzer_Time(ms)` (Buzzer.c - 已有)

```c
void Buzzer_Time(unsigned int ms)
{
    unsigned int i;
    for(i = 0; i < ms*2; i++)
    {
        Buzzer =!Buzzer;
        Buzzer_Delay500us();
    }
}
```

**原理**：
- 每500us翻转一次蜂鸣器引脚电平
- 翻转周期：1000us = 1ms
- 频率：1 / 1ms = 1kHz

#### `Buzzer_Alarm()` (main.c - 已更新)

```c
void Buzzer_Alarm(void) {
    LCD_ShowString(1, 1, "Wrong Password! ");
    LCD_ShowString(2, 1, "Buzzer Alarm... ");
    
    // 调用蜂鸣器报警3秒函数
    Buzzer_Alarm_3s();
    
    // 显示完成信息
    LCD_ShowString(2, 1, "Alarm Stopped!  ");
    Delay(1000); // 显示1秒
}
```

---

## 🎯 密码锁集成

### 完整流程（在 Safe_Proc() 函数中）

```c
// 输入完成处理
if (Current_Input.Input_Finished) {
    if (Safe_Mode) {
        // 设置密码模式
        Password_Save();
        // ...
    } else {
        // 验证密码模式
        if (Password_Verify()) {
            // ✅ 密码正确
            Password_Verified = 1;
            LCD_ShowString(1, 1, "Password OK!    ");
            LCD_ShowString(2, 1, "Opening Door... ");
            Delay(1000);
            
            // 调用步进电机开门
            Motor_OpenDoor();
            
            Password_Verified = 0;
        } else {
            // ❌ 密码错误
            Password_Error = 1;
            
            // 🔔 调用蜂鸣器报警函数（报警3秒）
            Buzzer_Alarm();
            
            Password_Error = 0;
        }
    }
    
    // 重新初始化输入
    IR_Input_Init(PASSWORD_LENGTH, 0);
    Current_Input.Input_Finished = 0;
    Flag_100ms_Task = 1;
}
```

---

## 📊 技术参数

### 蜂鸣器参数

| 参数 | 值 | 说明 |
|-----|---|------|
| 控制引脚 | P2.5 | STC89C52单片机 |
| 蜂鸣器类型 | 无源蜂鸣器 | 需要PWM信号 |
| 工作电压 | 3.3V 或 5V | 根据蜂鸣器规格 |
| 报警频率 | ~1kHz | 翻转周期1ms |
| 报警时长 | 3000ms | 3秒 |
| 延时精度 | 500us | @11.0592MHz晶振 |

### 时序参数

| 事件 | 时间 |
|-----|------|
| 显示"Wrong Password!" | 立即 |
| 显示"Buzzer Alarm..." | 立即 |
| 蜂鸣器响 | 3.0秒 |
| 显示"Alarm Stopped!" | 1.0秒 |
| **总耗时** | **~4.0秒** |

---

## 🧪 功能测试

### 测试步骤

#### 1. 进入密码锁模式
```
按 MODE 键 → 切换到 Safe 模式
LCD显示: "Enter Password:"
```

#### 2. 输入错误密码
```
例如输入: 11111111（假设正确密码是12345678）
依次按数字键: 1 1 1 1 1 1 1 1
按 EQ 键确认
```

#### 3. 观察蜂鸣器报警
```
LCD第一行显示: "Wrong Password!"
LCD第二行显示: "Buzzer Alarm..."
蜂鸣器响起，持续3秒
频率约1kHz（听起来像"哔哔哔"的连续音）
```

#### 4. 检查停止状态
```
3秒后蜂鸣器自动停止
LCD第二行显示: "Alarm Stopped!"
显示1秒后返回密码输入界面
```

### 测试清单

| 检查项 | 预期结果 | 实际结果 |
|-------|---------|---------|
| 密码错误触发 | 输入错误密码后触发报警 | ⬜ |
| LCD显示 | 显示"Wrong Password!" | ⬜ |
| 蜂鸣器响起 | 蜂鸣器发出声音 | ⬜ |
| 报警时长 | 持续约3秒 | ⬜ |
| 声音频率 | 约1kHz，听起来清晰 | ⬜ |
| 自动停止 | 3秒后自动停止 | ⬜ |
| 停止提示 | 显示"Alarm Stopped!" | ⬜ |
| 返回输入 | 返回密码输入界面 | ⬜ |

---

## 🔧 常见问题

### Q1: 蜂鸣器不响？

**可能原因**：
- 蜂鸣器接线错误
- 使用了有源蜂鸣器（需要修改代码）
- P2.5引脚电平不翻转

**解决方法**：
1. 检查接线：P2.5 → 蜂鸣器I/O，VCC → 电源，GND → 地
2. 确认使用无源蜂鸣器
3. 测试代码：
   ```c
   Buzzer = 0;  // 输出低电平
   Delay(1000);
   Buzzer = 1;  // 输出高电平
   ```

### Q2: 声音很小或者没有音调？

**可能原因**：
- 频率不对
- 蜂鸣器型号不匹配

**解决方法**：
- 调整 `Buzzer_Delay500us()` 中的延时值
- 尝试不同的翻转频率：
  ```c
  // 更高频率（2kHz）
  void Buzzer_Delay250us() { ... }
  
  // 更低频率（500Hz）
  void Buzzer_Delay1ms() { ... }
  ```

### Q3: 报警时长不准确？

**可能原因**：
- 晶振频率不是11.0592MHz
- 延时函数精度问题

**解决方法**：
- 确认晶振频率
- 调整 `Buzzer_Time()` 的参数：
  ```c
  Buzzer_Time(3000);  // 当前设置
  // 如果时长偏短，增大参数
  Buzzer_Time(3200);
  ```

### Q4: 报警后蜂鸣器持续响？

**可能原因**：
- `Buzzer = 1;` 语句未执行
- 蜂鸣器引脚未正确关闭

**解决方法**：
- 确保 `Buzzer_Alarm_3s()` 末尾有 `Buzzer = 1;`
- 检查是否有其他地方控制了P2.5引脚

### Q5: 使用有源蜂鸣器怎么办？

**修改方法**（有源蜂鸣器只需高电平即可响）：

```c
void Buzzer_Alarm_3s(void)
{
    Buzzer = 0;      // 有源蜂鸣器：低电平响
    Delay(3000);     // 响3秒
    Buzzer = 1;      // 高电平停止
}
```

---

## 🎓 进阶功能

### 1. 多段报警音

```c
void Buzzer_Alert_Pattern(void)
{
    unsigned char i;
    for (i = 0; i < 3; i++) {
        Buzzer_Time(300);   // 响0.3秒
        Delay(200);         // 停0.2秒
    }
    Buzzer = 1;            // 确保停止
}
```

### 2. 可调频率

```c
void Buzzer_Tone(unsigned int frequency_hz, unsigned int duration_ms)
{
    unsigned int i;
    unsigned int period_us = 1000000 / frequency_hz / 2;
    unsigned int cycles = (unsigned long)frequency_hz * duration_ms / 1000;
    
    for (i = 0; i < cycles; i++) {
        Buzzer = !Buzzer;
        Delay_us(period_us);  // 需要实现微秒延时
    }
    Buzzer = 1;
}

// 使用示例
Buzzer_Tone(1000, 3000);  // 1kHz，3秒
```

### 3. 报警优先级

```c
typedef enum {
    ALARM_LOW,     // 低优先级：短促警报
    ALARM_MEDIUM,  // 中优先级：标准警报（3秒）
    ALARM_HIGH     // 高优先级：长时警报（5秒）
} Alarm_Priority;

void Buzzer_Alarm_Priority(Alarm_Priority priority)
{
    switch (priority) {
        case ALARM_LOW:
            Buzzer_Time(1000);  // 1秒
            break;
        case ALARM_MEDIUM:
            Buzzer_Time(3000);  // 3秒
            break;
        case ALARM_HIGH:
            Buzzer_Time(5000);  // 5秒
            break;
    }
    Buzzer = 1;
}
```

---

## 📐 波形分析

### 蜂鸣器驱动波形

```
时间轴（us）:  0    500   1000  1500  2000  2500  3000
             ___      ___      ___      ___      ___
P2.5:      _|   |____|   |____|   |____|   |____|   |____
            
            ↑_______↑
            500us周期

频率 = 1 / (2 × 500us) = 1kHz
```

### 报警时序图

```
事件:          密码错误    显示提示    蜂鸣器启动             蜂鸣器停止  显示停止信息
             |           |           |                       |           |
时间(s):      0          0.01         0.01                  3.01        3.01
             |-----------|-----------|---------------------|-----------|
                 10ms        0ms           3000ms              0ms
                            
LCD1:        [Enter Pass] → [Wrong Password!] ---------------→ [Wrong Password!]
LCD2:        [________  ] → [Buzzer Alarm...] ---------------→ [Alarm Stopped! ]
Buzzer:      [____OFF___] → [______ON_______] ---------------→ [____OFF_______]
```

---

## 🔊 声音特性

### 频率与音调对照

| 频率 | 音调 | 适用场景 |
|-----|------|---------|
| 500Hz | 低沉 | 低优先级提示 |
| 1kHz | 标准 | **密码错误报警（当前）** |
| 2kHz | 尖锐 | 高优先级警报 |
| 4kHz | 刺耳 | 紧急警报 |

当前实现：**1kHz**，听感清晰，不刺耳，适合密码错误提示。

---

## 📝 代码优化建议

### 1. 非阻塞报警（进阶）

当前实现是阻塞式的（报警期间无法执行其他任务）。如果需要非阻塞：

```c
// 使用定时器中断实现
bit Buzzer_Alarm_Active = 0;
unsigned int Buzzer_Alarm_Timer = 0;

void Timer_ISR() interrupt 1
{
    if (Buzzer_Alarm_Active) {
        Buzzer = !Buzzer;  // 1kHz翻转
        if (++Buzzer_Alarm_Timer >= 3000) {
            Buzzer_Alarm_Active = 0;
            Buzzer = 1;
        }
    }
}

void Buzzer_Alarm_Start(void)
{
    Buzzer_Alarm_Timer = 0;
    Buzzer_Alarm_Active = 1;
}
```

### 2. 音量控制（使用PWM）

通过调整PWM占空比控制音量：

```c
void Buzzer_Volume(unsigned char volume)
{
    // volume: 0-100
    // 实现PWM占空比控制
}
```

---

## ✅ 完成清单

- [x] Buzzer.h添加函数声明
- [x] Buzzer.c实现报警3秒函数
- [x] main.c更新Buzzer_Alarm调用
- [x] 代码编译无错误
- [ ] 硬件连接测试
- [ ] 密码错误触发测试
- [ ] 报警时长验证（3秒）
- [ ] 声音清晰度检查

---

## 🎯 总结

本次实现完成了密码锁系统中的蜂鸣器报警功能：

✅ **功能完整**：密码错误时自动触发报警  
✅ **时长准确**：报警持续3秒后自动停止  
✅ **音调合适**：1kHz频率，听感清晰  
✅ **提示友好**：LCD显示报警状态和停止信息  
✅ **代码简洁**：模块化设计，易于维护和扩展

代码已完成并通过编译，可直接烧录到硬件进行测试。

---

**版本**: v1.0  
**日期**: 2025-10-15  
**项目**: 密码锁系统 - 蜂鸣器报警功能  
**测试状态**: ✅ 代码完成，待硬件测试
