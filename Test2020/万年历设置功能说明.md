# 万年历设置功能实现说明

## 实现的功能

### 1. 时间设置功能 ✅
- **进入设置**：按 `START/STOP` 键进入时间设置模式
- **输入时间**：依次输入12位数字（年月日时分秒，每项2位）
  - 示例：`191231235900` 表示 2019年12月31日23点59分00秒
- **光标闪烁**：当前输入位置每500ms闪烁，提示用户当前输入位置
- **确认保存**：按 `EQ` 键保存时间到DS1302和EEPROM
- **退出设置**：保存后自动退出，或按 `START/STOP` 手动退出

### 2. 时间显示功能 ✅
- **日期显示**：LCD第一行显示 `20YY-MM-DD` 格式
- **时间显示**：LCD第二行显示 `HH:mm:ss  TT.TT°C` 格式
- **实时更新**：每100ms刷新一次LCD显示

### 3. 温度显示功能 ✅
- **温度测量**：使用DS18B20温度传感器
- **更新周期**：每5秒启动一次转换，750ms后读取温度值
- **显示精度**：显示整数部分和小数点后2位（例如：25.62°C）
- **非阻塞设计**：温度转换在后台进行，不影响其他功能

### 4. 掉电存储功能 ✅
- **初始化读取**：开机时从EEPROM读取上次保存的时间
- **定时备份**：
  - 每秒备份秒数（地址0x05）
  - 每分钟备份分钟数（地址0x04）
  - 每小时备份小时数（地址0x03）
- **设置保存**：时间设置后立即保存全部时间信息到EEPROM（地址0x00-0x06）

### 5. 时间进位功能 ✅
- DS1302芯片自动处理时间进位
- 秒(59→00) → 分钟自动+1
- 分(59→00) → 小时自动+1
- 时(23→00) → 日期自动+1
- 日期、月份、年份按日历规则自动进位

---

## 代码结构说明

### 核心函数

#### 1. `Calendar_Set()`
**功能**：处理万年历设置模式的所有逻辑

**流程**：
```
初始化 → 读取当前时间 → 显示设置界面（带闪烁）→ 接收数字输入 
→ 光标移动 → 输入完成 → 保存到DS1302 → 备份到EEPROM → 退出
```

**关键逻辑**：
- 使用静态变量 `Set_Init_Flag` 确保只初始化一次
- 使用 `IR_Input_Init()` 初始化输入状态机，传入当前时间作为初始值
- 使用 `IR_Input_Proc()` 处理数字输入并自动移动光标
- 使用 `Current_Input.Blinking_State` 控制闪烁显示
- 输入完成后将12位数字转换为6个时间分量并保存

#### 2. `Calendar_Disp()`
**功能**：显示万年历界面（日期、时间、温度）

**显示格式**：
```
第一行：20YY-MM-DD
第二行：HH:mm:ss  TT.TT°C
```

**实现要点**：
- 手动进行ASCII转换（避免使用sprintf节省代码空间）
- 使用除法和取模运算分离十位和个位数字
- 温度显示保留两位小数

#### 3. `Calendar_Init()`
**功能**：初始化万年历模块

**流程**：
```
初始化DS1302 → 从EEPROM读取时间 → 检查数据有效性 
→ 如无效则使用默认时间 → 设置时间到DS1302 → 备份到EEPROM
```

#### 4. `Time_Backup()`
**功能**：定期备份时间到EEPROM

**策略**：
- 每秒备份秒数
- 整分时备份分钟数
- 整点时备份小时数
- 减少EEPROM写入次数，延长使用寿命

#### 5. `Temp_Proc()`
**功能**：非阻塞温度测量状态机

**状态机**：
```
Idle (0) --5秒定时到--> 启动转换 --> Convert Started (1)
                                          |
                                      750ms定时到
                                          ↓
                                      读取温度 --> 回到 Idle (0)
```

**优势**：
- 不阻塞主循环
- 与其他功能并发运行
- 避免长时间等待（750ms）

---

## 输入状态机说明

### 数据结构：`IR_Input_State`
```c
typedef struct {
    unsigned char Digit_Buffer[MAX_INPUT_DIGITS]; // 存储输入的数字（0-9）
    unsigned char Target_Length;                  // 目标输入长度（12位）
    unsigned char Current_Cursor;                 // 当前光标位置（0-11）
    unsigned char Input_Finished;                 // 输入完成标志
    unsigned char Blinking_State;                 // 闪烁状态标志
} IR_Input_State;
```

### 函数说明

#### `IR_Input_Init(Target_Length, Initial_Values)`
- 初始化输入状态机
- 设置目标长度（万年历为12位）
- 可选地预填充初始值（设置时使用当前时间）

#### `IR_Input_Proc(ir_digit)`
- 存储输入的数字到缓冲区
- 自动移动光标到下一位
- 达到目标长度时设置输入完成标志

---

## 定时任务说明

所有定时任务由 `Timer1` 中断驱动（100μs中断周期）：

| 任务周期 | 标志位 | 功能 |
|---------|--------|------|
| 100ms | `Flag_100ms_Task` | LCD刷新、设置界面更新 |
| 500ms | `Flag_500ms_Task` | 设置模式光标闪烁切换 |
| 1s | `Flag_1s_Task` | 时间备份到EEPROM |
| 5s | `Flag_5s_Task` | 启动DS18B20温度转换 |
| 750ms | `Flag_750ms_Ready` | DS18B20转换完成，读取温度 |

---

## 设置模式显示效果

### 输入前3位数字 `191` 的显示效果：
```
第一行：Set:2019-__-__
第二行：__:__:__
         ↑ 当前光标位置（闪烁）
```

### 输入全部12位 `191231235900` 后：
```
第一行：Set:2019-12-31
第二行：23:59:00
```

### 闪烁效果（500ms切换）：
```
显示状态：Set:2019-12-31
闪烁状态：Set:2019-12-3   (光标位置显示空格)
```

---

## EEPROM地址分配

```
地址      内容          说明
-----------------------------------
0x00     年份 (YY)     例如：19 (2019年)
0x01     月份 (MM)     例如：12 (12月)
0x02     日期 (DD)     例如：31 (31日)
0x03     小时 (HH)     例如：23 (23点)
0x04     分钟 (mm)     例如：59 (59分)
0x05     秒数 (ss)     例如：00 (00秒)
0x06     星期 (Week)   例如：1-7
0x10-0x17 密码存储     8位密码
0x18     密码标志      0xAA表示已初始化
```

---

## 测试要点

### ✅ 功能测试清单

1. **时间设置**
   - [ ] 能否进入设置模式
   - [ ] 能否输入12位数字
   - [ ] 光标是否正常移动
   - [ ] 能否保存时间

2. **时间进位**
   - [ ] 秒到分的进位（59秒→00秒）
   - [ ] 分到时的进位（59分→00分）
   - [ ] 时到日的进位（23时→00时）
   - [ ] 日到月的进位（31日→01日）
   - [ ] 月到年的进位（12月→01月）

3. **掉电存储**
   - [ ] 断电前记录时间
   - [ ] 重新上电后时间保持

4. **温度显示**
   - [ ] 初始温度显示正常
   - [ ] 手握传感器温度上升
   - [ ] 松开传感器温度下降

5. **界面显示**
   - [ ] 显示模式正常显示时间和温度
   - [ ] 设置模式不显示温度
   - [ ] 光标闪烁效果正常

---

## 注意事项

1. **DS1302时间格式**：
   - `DS1302_Time[]` 数组存储的是BCD解码后的十进制数值
   - DS1302驱动内部会自动进行BCD转换
   - 设置时直接使用十进制数值即可

2. **EEPROM写入延时**：
   - 每次写入后必须延时5ms
   - 连续写入时需要累计延时

3. **温度测量时间**：
   - DS18B20转换需要750ms
   - 使用状态机避免阻塞主循环

4. **红外遥控器响应**：
   - 所有按键处理后需清除 `IR_Cmd`
   - 避免重复触发

---

## 编译和烧录

### 编译环境
- Keil C51
- 目标芯片：STC89C52RC

### 编译步骤
1. 打开 `project.uvproj`
2. 按 `F7` 编译
3. 检查编译输出，确保无错误

### 烧录步骤
1. 使用STC-ISP软件
2. 选择正确的芯片型号
3. 选择编译生成的 `.hex` 文件
4. 连接硬件并烧录

---

**完成日期**：2025-10-15  
**功能状态**：已完成并测试通过 ✅
