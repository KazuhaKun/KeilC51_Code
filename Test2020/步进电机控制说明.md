# 28BYJ-48步进电机控制说明

## 一、硬件规格

### 步进电机型号：28BYJ-48
- **类型**：五线四相减速步进电机
- **工作电压**：5V DC
- **减速比**：1:64
- **步距角**：5.625° / 64 ≈ 0.088°
- **一圈步数**：
  - 四拍模式（全步）：512步
  - 八拍模式（半步）：1024步

### 驱动芯片：ULN2003D
- **功能**：达林顿晶体管阵列
- **输入电压**：5V TTL兼容
- **输出能力**：500mA/通道
- **保护**：内置钳位二极管

---

## 二、硬件连接

### 1. STC89C52 → ULN2003D

| STC89C52引脚 | ULN2003D输入 | 功能说明 |
|-------------|-------------|---------|
| P1.0 | IN1 (引脚1) | 控制电机A相 |
| P1.1 | IN2 (引脚2) | 控制电机B相 |
| P1.2 | IN3 (引脚3) | 控制电机C相 |
| P1.3 | IN4 (引脚4) | 控制电机D相 |
| GND | GND (引脚8) | 共地 |

### 2. ULN2003D → 28BYJ-48

| ULN2003D输出 | 步进电机线序 | 线色（典型） |
|-------------|------------|------------|
| OUT1 (引脚16) | 绕组A | 橙色 |
| OUT2 (引脚15) | 绕组B | 黄色 |
| OUT3 (引脚14) | 绕组C | 粉色 |
| OUT4 (引脚13) | 绕组D | 蓝色 |
| VCC (5V) | 公共端 | 红色 |

### 3. 电源连接

| 组件 | 引脚 | 连接到 |
|-----|------|--------|
| ULN2003D | VCC | 5V电源 |
| ULN2003D | GND | 电源地 |
| ULN2003D | COM (引脚9) | 5V电源（钳位二极管用） |
| 步进电机 | 红线（公共端） | 5V电源 |

**注意**：
- STC89C52、ULN2003D、步进电机必须共地
- 建议使用独立的5V电源供电（≥500mA）
- 如果电机转动方向不对，交换任意两根绕组线

---

## 三、驱动原理

### 四拍驱动时序（高扭矩模式）

本项目采用**四拍驱动**，每次点亮两相绕组，提供更大的扭矩。

| 步数 | P1.3(D) | P1.2(C) | P1.1(B) | P1.0(A) | 十六进制 | 说明 |
|-----|---------|---------|---------|---------|---------|------|
| 1 | 0 | 0 | 1 | 1 | 0x03 | A+B相通电 |
| 2 | 0 | 1 | 1 | 0 | 0x06 | B+C相通电 |
| 3 | 1 | 1 | 0 | 0 | 0x0C | C+D相通电 |
| 4 | 1 | 0 | 0 | 1 | 0x09 | D+A相通电 |

**正转**：按 1→2→3→4→1 的顺序循环  
**反转**：按 4→3→2→1→4 的顺序循环

### 转速控制

转速由步进间隔时间决定：
- **延时时间越短** → 转速越快
- **延时时间越长** → 转速越慢

本项目设置：
- 每步延时：**2ms**
- 一圈耗时：512步 × 2ms = **1024ms** ≈ **1秒**
- 转速：约 **60 RPM**（转/分钟）

---

## 四、代码实现

### 1. 引脚定义（Motor.c）

```c
// 步进电机引脚定义 - 28BYJ-48 (使用P1口的低4位)
sbit Stepper_A = P1^0;  // 对应电机A相，连接ULN2003D的IN1
sbit Stepper_B = P1^1;  // 对应电机B相，连接ULN2003D的IN2
sbit Stepper_C = P1^2;  // 对应电机C相，连接ULN2003D的IN3
sbit Stepper_D = P1^3;  // 对应电机D相，连接ULN2003D的IN4
```

### 2. 四拍时序数组

```c
// 四拍驱动时序数组（高扭矩模式）
code unsigned char Stepper_Code_4_Step[4] = {
    0x03, // 0011B (A, B ON)
    0x06, // 0110B (B, C ON)
    0x0C, // 1100B (C, D ON)
    0x09  // 1001B (D, A ON)
};
```

### 3. 核心函数

#### (1) `Stepper_Motor_Rotate(steps, direction)`

**功能**：驱动步进电机旋转指定步数

**参数**：
- `steps`：步数（unsigned int）
- `direction`：方向（0=正转，1=反转）

**示例**：
```c
// 正转一圈（512步）
Stepper_Motor_Rotate(512, 0);

// 反转半圈（256步）
Stepper_Motor_Rotate(256, 1);
```

#### (2) `Stepper_Motor_OpenDoor(void)`

**功能**：开门动作（正转5圈后反转5圈）

**流程**：
```
正转5圈 (2560步) → 暂停500ms → 反转5圈 (2560步) → 停止
```

**耗时**：
- 正转5圈：2560步 × 2ms = 5120ms ≈ **5.1秒**
- 暂停：**0.5秒**
- 反转5圈：2560步 × 2ms = 5120ms ≈ **5.1秒**
- **总计**：约 **10.7秒**

---

## 五、密码锁开门流程

### 完整流程图

```
用户输入密码 (8位)
    ↓
密码验证
    ↓
  正确？
   ├─ 是 → LCD显示"Password OK!"
   │        ↓
   │      LCD显示"Opening Door..."
   │        ↓
   │      调用 Motor_OpenDoor()
   │        ↓
   │      步进电机正转5圈
   │        ↓
   │      暂停500ms
   │        ↓
   │      步进电机反转5圈
   │        ↓
   │      LCD显示"Door Opened!"
   │        ↓
   │      返回密码输入界面
   │
   └─ 否 → LCD显示"Wrong Password!"
            ↓
          蜂鸣器报警3秒
            ↓
          返回密码输入界面
```

### 相关代码（main.c）

```c
void Motor_OpenDoor(void) {
    LCD_ShowString(1, 1, "Door Opening... ");
    LCD_ShowString(2, 1, "Motor Forward.. ");
    
    // 调用步进电机开门函数（正转5圈后反转5圈）
    Stepper_Motor_OpenDoor();
    
    LCD_ShowString(1, 1, "Door Opened!    ");
    LCD_ShowString(2, 1, "Press Key...    ");
    Delay(2000); // 显示2秒
}
```

---

## 六、功能测试

### 测试项目：步进电机开门测试

**目标**：验证密码正确后，步进电机是否正转5圈后反转5圈

**步骤**：

1. **进入密码锁模式**
   - 按 `MODE` 键，切换到密码锁模式（Safe模式）
   - LCD显示：`Enter Password:`

2. **输入正确密码**
   - 默认密码：`12345678`
   - 依次按数字键：`1` `2` `3` `4` `5` `6` `7` `8`
   - 按 `EQ` 键确认

3. **观察步进电机动作**
   - LCD第一行显示：`Door Opening...`
   - LCD第二行显示：`Motor Forward..`
   - 观察步进电机：
     - ✅ 应正转5圈（顺时针旋转）
     - ✅ 暂停约0.5秒
     - ✅ 反转5圈（逆时针旋转）
     - ✅ 停止

4. **检查完成状态**
   - LCD显示：`Door Opened!`
   - 电机停止运行（所有相关闭）
   - 系统返回密码输入界面

### 预期结果

| 检查项 | 预期结果 | 判定 |
|-------|---------|------|
| 密码验证 | 正确后进入开门流程 | ✅ |
| 正转圈数 | 正转5圈 | ✅ |
| 中间暂停 | 暂停约0.5秒 | ✅ |
| 反转圈数 | 反转5圈 | ✅ |
| 运行平稳 | 无卡顿、无异响 | ✅ |
| 停止状态 | 完成后电机停止 | ✅ |
| LCD提示 | 显示"Door Opened!" | ✅ |

### 常见问题排查

#### Q1: 电机不转或抖动
**原因**：
- 接线错误
- 电源电压不足
- 步序错误

**解决方法**：
- 检查P1.0-P1.3与ULN2003D的IN1-IN4连接
- 确保5V电源供电充足（≥500mA）
- 检查四拍时序数组是否正确

#### Q2: 电机转向错误
**原因**：
- 绕组线接反

**解决方法**：
- 交换ULN2003D的OUT1-OUT4任意两根线

#### Q3: 转速过快或过慢
**原因**：
- 步进间隔延时不合适

**解决方法**：
- 修改 `Stepper_Motor_Rotate()` 函数中的 `Delay(2)` 值
- 增大延时 → 降低转速
- 减小延时 → 提高转速

#### Q4: 电机发热严重
**原因**：
- 长时间保持通电状态

**解决方法**：
- 确保旋转完成后调用 `P1 = P1 & 0xF0;` 关闭所有相
- 减少不必要的保持时间

#### Q5: 圈数不准确
**原因**：
- 步数计算错误
- 机械负载过大导致失步

**解决方法**：
- 检查 `steps_per_circle = 512` 是否正确
- 减小负载或降低转速
- 使用八拍模式提高精度

---

## 七、进阶功能

### 1. 调整转速

修改 `Stepper_Motor_Rotate()` 函数中的延时：

```c
// 快速模式（约120 RPM）
Delay(1); // 1ms延时

// 标准模式（约60 RPM）
Delay(2); // 2ms延时（当前设置）

// 慢速模式（约30 RPM）
Delay(4); // 4ms延时

// 超慢速模式（约15 RPM）
Delay(8); // 8ms延时
```

### 2. 切换到八拍模式（更平稳）

修改 `Motor.c` 中的时序数组：

```c
// 八拍驱动时序数组（半步模式，更平稳）
code unsigned char Stepper_Code_8_Step[8] = {
    0x01, // 0001B (A)
    0x03, // 0011B (A+B)
    0x02, // 0010B (B)
    0x06, // 0110B (B+C)
    0x04, // 0100B (C)
    0x0C, // 1100B (C+D)
    0x08, // 1000B (D)
    0x09  // 1001B (D+A)
};

// 修改步数：一圈 = 1024步（八拍）
unsigned int steps_per_circle = 1024;
```

### 3. 精确角度控制

```c
// 计算指定角度所需步数（四拍模式）
// 步距角：5.625° / 64 ≈ 0.088°
// 一圈360°需要 512步
unsigned int Angle_To_Steps(float angle) {
    return (unsigned int)(angle / 360.0 * 512.0);
}

// 示例：旋转90度
Stepper_Motor_Rotate(Angle_To_Steps(90), 0); // 128步
```

---

## 八、技术参数总结

| 参数 | 数值 | 说明 |
|-----|------|------|
| 步进电机型号 | 28BYJ-48 | 五线四相减速步进电机 |
| 工作电压 | 5V DC | 标准TTL电压 |
| 驱动方式 | 四拍（全步） | 高扭矩模式 |
| 步距角 | 0.088° | 5.625° / 64 |
| 一圈步数 | 512步 | 四拍模式 |
| 步进间隔 | 2ms | 控制转速 |
| 转速 | ~60 RPM | 每分钟约60转 |
| 开门动作 | 正转5圈+反转5圈 | 共10圈，约10.7秒 |
| 电流消耗 | <500mA | 单相最大电流 |
| 控制引脚 | P1.0-P1.3 | STC89C52的P1口 |

---

## 九、电路原理图参考

```
STC89C52          ULN2003D          28BYJ-48
---------         ---------         ---------
                                    
P1.0 ---------> IN1 ---> OUT1 ---> 橙线 (A)
P1.1 ---------> IN2 ---> OUT2 ---> 黄线 (B)
P1.2 ---------> IN3 ---> OUT3 ---> 粉线 (C)
P1.3 ---------> IN4 ---> OUT4 ---> 蓝线 (D)
                                    
GND  ---------> GND               
                                    
         5V --> VCC                
         5V --> COM                
                                    红线 <--- 5V
```

---

## 十、注意事项

1. **电源要求**
   - 必须使用稳定的5V电源
   - 电流容量≥500mA
   - 建议使用独立电源（避免影响单片机）

2. **接线顺序**
   - 严格按照A-B-C-D顺序连接
   - 如果转向错误，只需交换任意两根线

3. **散热问题**
   - 长时间运行会发热，属正常现象
   - 运行完成后应关闭所有相
   - 避免长时间保持通电

4. **机械负载**
   - 不要超载运行（扭矩有限）
   - 负载过大会导致失步
   - 可通过降低转速提高扭矩

5. **代码兼容性**
   - `Delay()` 函数需要提前定义
   - P1口与其他功能共用时需注意冲突
   - Timer1中断不影响步进电机控制

---

**文档版本**：v1.0  
**编写日期**：2025-10-15  
**适用项目**：密码锁系统（步进电机开门功能）  
**测试状态**：✅ 代码已完成，待硬件测试
