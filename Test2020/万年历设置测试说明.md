# 万年历设置功能测试说明

## 功能概述
万年历模块支持红外遥控器设置时间，实时显示环境温度，并具备掉电存储功能。

## 操作说明

### 1. 进入设置模式
- 按遥控器 **`START/STOP`** 键进入时间设置模式
- LCD第一行显示：`Set:20YY-MM-DD`
- LCD第二行显示：`HH:mm:ss`

### 2. 输入时间
依次输入**12位数字**（每个时间分量2位）：
- **年份**：2位（例如：19表示2019年）
- **月份**：2位（例如：12表示12月）
- **日期**：2位（例如：31表示31日）
- **小时**：2位（例如：23表示23点）
- **分钟**：2位（例如：59表示59分）
- **秒数**：2位（例如：00表示00秒）

**示例**：设置为 `2019年12月31日23点59分00秒`
```
按键序列：1 → 9 → 1 → 2 → 3 → 1 → 2 → 3 → 5 → 9 → 0 → 0
```

### 3. 确认保存
- 输入完12位数字后，按 **`EQ`** 键确认保存
- LCD显示 `Time Saved!` 1秒后自动退出设置模式
- 时间自动写入DS1302并保存到EEPROM

### 4. 退出设置模式
- 按 **`START/STOP`** 键可随时退出设置模式
- 按 **`MODE`** 键可切换到其他功能模式

## 测试项目

### 测试1：时间设置测试
**目标**：验证能否将时间修改为2019年12月31日23点59分00秒

**步骤**：
1. 按 `START/STOP` 键进入设置模式
2. 依次按下：`1` `9` `1` `2` `3` `1` `2` `3` `5` `9` `0` `0`
3. 按 `EQ` 键保存
4. 观察LCD第一行是否显示：`2019-12-31`
5. 观察LCD第二行是否显示：`23:59:00  XX.XX°C`

**预期结果**：时间正确设置并显示

---

### 测试2：时间进位测试
**目标**：验证时钟各位是否正确进位

**步骤**：
1. 将时间设置为 `2019年12月31日23点59分00秒`
2. 等待1分钟，观察时间变化

**预期结果**：
- 59秒 → 00秒后，分钟从59变为00
- 23点59分 → 00点00分后，小时从23变为00
- 12月31日 → 1月1日，日期从31变为01，月份从12变为01
- 2019年 → 2020年，年份从19变为20

**观察点**：
```
23:59:00 → 23:59:01 → ... → 23:59:59
                              ↓
                         00:00:00 (次日)
2019-12-31 → 2020-01-01
```

---

### 测试3：掉电存储测试
**目标**：验证断电后重新上电，时间是否保持

**步骤**：
1. 记录当前时间（例如：`2019-12-31 23:59:30`）
2. 断电（拔掉电源或按复位键）
3. 等待几秒
4. 重新上电
5. 观察LCD显示的时间

**预期结果**：
- 如果断电时间很短（几秒内），时间应接近断电前的时间
- DS1302掉电后会停止计时，但EEPROM中保存了最后的时间
- 重新上电后，时间从EEPROM恢复，并继续运行

**注意**：DS1302有掉电保持功能（需要备用电池），如果有备用电池，时间会继续准确计时

---

### 测试4：温度显示测试
**目标**：验证温度传感器是否正常工作

**步骤**：
1. 开机后等待5秒，观察初始温度值（应为室温，约20-25°C）
2. 用手握住温度传感器（DS18B20）
3. 等待10-15秒，观察温度是否上升（应上升到30-35°C）
4. 松开温度传感器
5. 等待15-20秒，观察温度是否下降（应回到室温）

**预期结果**：
- 初始温度显示正常（20-25°C）
- 手握后温度明显上升（+5°C以上）
- 松开后温度逐渐下降到室温

**温度更新周期**：
- DS18B20每5秒启动一次温度转换
- 转换需要750ms完成
- 因此温度值约每5.75秒刷新一次

---

### 测试5：闪烁显示测试
**目标**：验证设置模式下的光标闪烁效果

**步骤**：
1. 按 `START/STOP` 键进入设置模式
2. 观察当前光标位置是否每500ms闪烁一次
3. 输入一个数字，观察光标是否移动到下一位
4. 继续输入，观察闪烁效果是否正常

**预期结果**：
- 当前待输入位置每500ms闪烁（显示/隐藏）
- 输入数字后，光标自动移动到下一位
- 闪烁效果流畅，无卡顿

---

## 红外遥控器按键说明

| 按键 | 功能 |
|------|------|
| `MODE` | 切换功能模式（万年历/密码锁/计算器） |
| `POWER` | 重置到万年历模式 |
| `START/STOP` | 进入/退出时间设置模式 |
| `0-9` | 输入数字 |
| `EQ` | 确认保存 |

---

## 常见问题

### Q1: 输入错误怎么办？
**A**: 按 `START/STOP` 键退出设置模式，重新进入后再次输入。

### Q2: 温度显示不准确？
**A**: 
- 确认DS18B20连接正确
- 等待至少10秒让温度稳定
- 温度传感器需要时间响应环境变化

### Q3: 掉电后时间丢失？
**A**: 
- 检查DS1302是否有备用电池（纽扣电池）
- 检查EEPROM连接是否正常
- 确认AT24C02写入成功（每次写入后需要5ms延时）

### Q4: 时间进位不正确？
**A**: 
- 确认DS1302驱动正确（BCD码转换）
- 检查DS1302是否正常运行（读取时间是否变化）
- 验证Timer1中断是否正常触发

---

## 技术细节

### EEPROM存储地址分配
```
0x00: 年份 (Year)
0x01: 月份 (Month)
0x02: 日期 (Day)
0x03: 小时 (Hour)
0x04: 分钟 (Minute)
0x05: 秒数 (Second)
0x06: 星期 (Week)
0x10-0x17: 密码存储区
0x18: 密码初始化标志
```

### 定时任务周期
- **100ms任务**：LCD刷新、输入处理
- **500ms任务**：闪烁切换
- **1s任务**：时间备份
- **5s任务**：启动温度转换
- **750ms任务**：读取温度值

### DS18B20温度转换流程
```
主循环 -> 每5秒启动转换 -> 等待750ms -> 读取温度 -> 显示 -> 等待下一个5秒周期
```

---

## 代码关键函数

1. **`Calendar_Init()`**: 初始化时间模块，从EEPROM读取时间
2. **`Calendar_Set()`**: 时间设置函数，处理输入和保存
3. **`Calendar_Disp()`**: 时间显示函数，刷新LCD
4. **`IR_Input_Init()`**: 初始化输入状态机
5. **`IR_Input_Proc()`**: 处理数字输入并移动光标
6. **`Time_Backup()`**: 定期备份时间到EEPROM
7. **`Temp_Proc()`**: 温度测量状态机

---

## 测试完成标准

✅ 能够通过红外遥控器输入12位数字  
✅ 时间设置后正确显示  
✅ 时间进位正确（秒→分→时→日→月→年）  
✅ 掉电后重新上电时间保持  
✅ 温度显示正常，响应环境变化  
✅ 设置模式光标闪烁正常  
✅ 设置模式不显示温度

---

**编写日期**: 2025-10-15  
**版本**: v1.0
