# STC89C52 多功能项目完整说明

## 🎯 项目概述

本项目基于 STC89C52 单片机，实现了三大功能模块：

1. **万年历模式 (Calendar)** - 时间显示和设置
2. **密码保险箱模式 (Safe)** - 8位密码验证和设置
3. **计算器模式 (Calculator)** - 四则运算计算器

## 📁 项目结构

```
Test2020/
├── main.c                          # 主程序
├── DS1302.c/h                      # 实时时钟驱动
├── DS18B20.c/h                     # 温度传感器驱动
├── AT24C02.c/h                     # EEPROM驱动
├── LCD1602.c/h                     # LCD显示驱动
├── IR.c/h                          # 红外遥控驱动
├── Motor.c/h                       # 步进电机驱动
├── Buzzer.c/h                      # 蜂鸣器驱动
├── Timer0.c/h                      # 定时器0
├── Timer1.c/h                      # 定时器1
├── 密码功能使用说明.md              # 密码功能详细文档
└── 计算器功能使用说明.md            # 计算器功能详细文档
```

## 🎮 模式切换

按红外遥控的 **MODE** 键循环切换模式：

```
Calendar → Safe → Calculator → Calendar → ...
```

按 **POWER** 键可以随时返回 Calendar 模式。

---

## 📅 模式 1: 万年历 (Calendar)

### 功能特点

- ✅ 实时时钟显示（年月日时分秒）
- ✅ 温度显示（DS18B20）
- ✅ 时间设置功能（12位数字输入）
- ✅ EEPROM 备份（断电保存）

### 操作说明

#### 显示模式
- 第一行：`20YY-MM-DD` (日期)
- 第二行：`HH:mm:ss  TT.TTC` (时间和温度)

#### 设置时间
1. 按 **START_STOP** 进入设置模式
2. 输入 12 位数字：YYMMDDHHMMSS
   - 例如：250115143000 = 2025年01月15日14点30分00秒
3. 按 **EQ** 保存
4. 自动返回显示模式

### 按键说明
- **START_STOP**: 切换显示/设置模式
- **0-9**: 输入数字
- **EQ**: 保存设置

---

## 🔐 模式 2: 密码保险箱 (Safe)

### 功能特点

- ✅ 8位数字密码设置
- ✅ 8位数字密码验证
- ✅ 密码正确：调用步进电机开门（预留）
- ✅ 密码错误：蜂鸣器报警3秒（预留）
- ✅ EEPROM 保存密码（断电不丢失）

### 默认密码

**12345678**

### 操作说明

#### 验证密码（默认）
1. 进入 Safe 模式
2. 输入 8 位密码
3. 按 **EQ** 确认
4. 密码正确 → 开门动作
5. 密码错误 → 蜂鸣器报警

#### 设置新密码
1. 在 Safe 模式按 **START_STOP** 切换到设置模式
2. 输入 8 位新密码
3. 按 **EQ** 保存
4. 显示 "Password Saved!"

### 按键说明
- **START_STOP**: 切换验证/设置模式
- **0-9**: 输入密码数字
- **EQ**: 确认输入

### 需要实现的函数

```c
// 在 main.c 第 175 行左右
void Motor_OpenDoor(void) {
    // TODO: 实现步进电机控制
    // 正转5圈后反转5圈
}

// 在 main.c 第 187 行左右
void Buzzer_Alarm(void) {
    // TODO: 实现蜂鸣器控制
    // 报警3秒后停止
}
```

---

## 🔢 模式 3: 计算器 (Calculator)

### 功能特点

- ✅ 加法：两个8位整数
- ✅ 减法：两个8位整数
- ✅ 乘法：两个4位整数
- ✅ 除法：两个8位整数，结果保留4位小数

### 操作流程

```
输入 Num1 → 选择运算符 → 输入 Num2 → 显示结果
```

### 详细步骤

#### 1. 输入第一个数 (Num1)
- 使用 **0-9** 输入数字（最多8位）
- 按 **EQ** 确认
- 按 **CH-** 清除当前输入

#### 2. 选择运算符
- 按 **CH+**: 加法 (+)
- 按 **CH-**: 减法 (-)
- 按 **1**: 乘法 (×)
- 按 **2**: 除法 (÷)

#### 3. 输入第二个数 (Num2)
- 使用 **0-9** 输入数字
- 乘法最多4位，其他最多8位
- 按 **EQ** 开始计算

#### 4. 查看结果
- 显示计算结果
- 除法结果保留4位小数
- 按任意数字键开始新计算

### 按键说明
- **0-9**: 输入数字
- **EQ**: 确认/计算
- **CH+**: 加法
- **CH-**: 减法/清除
- **1**: 乘法
- **2**: 除法
- **START_STOP**: 重新开始

### 使用示例

```
示例 1: 12345678 + 87654321 = 99999999
示例 2: 10000000 - 1234567 = 8765433
示例 3: 9999 × 8888 = 88881112
示例 4: 1234567 ÷ 100 = 12345.6700
```

---

## 🔧 硬件配置

### 引脚分配

| 外设 | 引脚 | 说明 |
|------|------|------|
| DS1302_CE | P3.5 | 实时时钟片选 |
| DS1302_IO | P3.4 | 实时时钟数据 |
| DS1302_SCLK | P3.6 | 实时时钟时钟 |
| DS18B20_DQ | P3.7 | 温度传感器单总线 |
| LCD1602 | P0 | LCD数据总线 |
| IR | P3.2 | 红外接收 |
| Motor | - | 步进电机（需要你实现） |
| Buzzer | - | 蜂鸣器（需要你实现） |

### EEPROM 地址分配

| 地址 | 用途 |
|------|------|
| 0x00-0x06 | 万年历时间数据 |
| 0x10-0x17 | 密码数据（8字节） |
| 0x18 | 密码初始化标志 |

---

## 📋 红外遥控按键总览

### 通用按键
- **MODE**: 切换模式（Calendar → Safe → Calculator）
- **POWER**: 返回 Calendar 模式

### Calendar 模式专用
- **START_STOP**: 切换显示/设置
- **0-9**: 输入时间
- **EQ**: 保存时间

### Safe 模式专用
- **START_STOP**: 切换验证/设置密码
- **0-9**: 输入密码
- **EQ**: 确认密码

### Calculator 模式专用
- **0-9**: 输入数字
- **EQ**: 确认/计算
- **CH+**: 加法
- **CH-**: 减法/清除
- **1**: 乘法
- **2**: 除法
- **START_STOP**: 重新开始

---

## ⚙️ 系统初始化

### main 函数初始化顺序

```c
void main() {
    // 温度传感器初始化
    DS18B20_ConvertT();
    Delay(750);
    Temperature = (int)DS18B20_ReadT();
    
    // 万年历初始化
    Calendar_Init();
    
    // 密码系统初始化
    Password_Init();
    
    // LCD初始化
    LCD_Init();
    
    // 红外初始化
    IR_Init();
    
    // 步进电机初始化
    Motor_Init();
    
    // 主循环
    while(1) {
        IR_Data_Proc();      // 红外数据处理
        Mode_Change();       // 模式切换处理
        
        Calendar_Proc();     // 万年历处理
        Safe_Proc();         // 密码处理
        Calculator_Proc();   // 计算器处理
    }
}
```

---

## 🎯 待完成任务

### 1. 步进电机控制

在 `Motor_OpenDoor()` 函数中实现：
- 正转5圈
- 延时
- 反转5圈

### 2. 蜂鸣器控制

在 `Buzzer_Alarm()` 函数中实现：
- 开启蜂鸣器
- 持续3秒
- 关闭蜂鸣器

---

## 🧪 测试建议

### Calendar 测试
1. 观察时间是否正常走动
2. 测试时间设置功能
3. 断电重启检查时间是否保存
4. 观察温度显示是否正常

### Safe 测试
1. 使用默认密码 12345678 验证
2. 故意输入错误密码测试报警
3. 设置新密码并验证
4. 断电重启检查新密码是否保存

### Calculator 测试
1. 测试加法：大数相加
2. 测试减法：包含负数结果
3. 测试乘法：4位数相乘
4. 测试除法：验证小数精度
5. 测试除零错误处理

---

## ⚠️ 注意事项

### 硬件兼容性
- **普中A2实验板**：P3.5 和 P3.7 可能与 XPT2046 冲突
- 如遇通信问题，检查引脚连接

### EEPROM 写入
- 每次写入后需要延时 5ms
- 避免频繁写入，减少 EEPROM 磨损

### 浮点运算
- 计算器使用 float 类型，注意精度限制
- 除法结果保留4位小数

### 输入限制
- Calendar: 12位数字
- Safe: 8位数字
- Calculator: 加减除8位，乘法4位

---

## 📊 功能对比表

| 功能 | Calendar | Safe | Calculator |
|------|----------|------|------------|
| 输入数字 | 12位 | 8位 | 4-8位 |
| EEPROM | 是 | 是 | 否 |
| 显示刷新 | 100ms | 100ms | 100ms |
| 外设使用 | DS1302, DS18B20 | Motor, Buzzer | - |

---

## 🚀 快速上手

### 第一次使用
1. 上传程序到单片机
2. 观察万年历显示（默认模式）
3. 按 MODE 键体验三种模式
4. 查阅各模式详细文档

### 开发建议
1. 先测试基本功能（显示、输入）
2. 再实现硬件控制（电机、蜂鸣器）
3. 最后进行完整功能测试

---

## 📚 相关文档

- 详细密码功能说明：`密码功能使用说明.md`
- 详细计算器说明：`计算器功能使用说明.md`

---

**项目开发完成度：90%**  
**待完成：步进电机和蜂鸣器驱动实现**

祝开发顺利！🎉
